// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"  // 使用 PostgreSQL
  url      = env("DATABASE_URL")
}

// ===== 員工/管理者資料模型 =====
model User {
  id            String    @id @default(cuid())
  username      String    @unique // 員工登入帳號，不可重複
  passwordHash  String    // 加密後的密碼
  role          String    @default("OPERATOR") // 角色：OPERATOR, ADMIN, SUPER_ADMIN
  
  // 員工資訊（全部設為可選，避免遷移問題）
  fullName      String?   // 員工全名
  email         String?   // 員工電子郵件
  phone         String?   // 員工聯絡電話
  department    String?   // 部門
  isActive      Boolean   @default(true) // 帳號是否啟用
  
  // 登入與安全（全部可選或有預設值）
  lastLoginAt   DateTime? // 最後登入時間
  loginAttempts Int       @default(0) // 登入失敗次數
  lockedUntil   DateTime? // 帳號鎖定到期時間
  
  // 時間戳記（重要：加入預設值避免遷移錯誤）
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @default(now()) @updatedAt  // 加入預設值
  
  // 關聯
  assignedOrders ShipmentOrder[] @relation("AssignedOrders")

  @@index([username])
  @@index([role])
  @@index([isActive])
  @@map("users")
}

// ===== 客戶會員資料模型 =====
model Customer {
  id              String    @id @default(cuid())
  email           String    @unique // 會員電子郵件，用於登入
  passwordHash    String    // 加密後的密碼
  
  // 基本資料
  name            String    // 會員姓名
  phone           String?   // 聯絡電話
  lineNickname    String?   // LINE 暱稱
  defaultAddress  String?   // 預設地址
  idNumber        String?   // 身分證字號
  taxId           String?   // 統一編號
  
  // 會員狀態與安全（全部有預設值）
  isActive        Boolean   @default(true) // 帳號狀態
  emailVerified   Boolean   @default(false) // 電子郵件是否已驗證
  phoneVerified   Boolean   @default(false) // 電話是否已驗證
  
  // 密碼管理（全部可選或有預設值）
  needPasswordChange Boolean @default(false) // 是否需要修改密碼
  passwordResetAt    DateTime? // 最後密碼重設時間
  passwordResetToken String?   // 密碼重設令牌
  passwordResetExpiry DateTime? // 密碼重設令牌到期時間
  
  // 會員等級與積分（全部有預設值）
  memberLevel     String    @default("BASIC") // BASIC, SILVER, GOLD, PLATINUM
  points          Int       @default(0) // 會員積分
  totalSpent      Float     @default(0) // 總消費金額
  
  // 登入記錄（全部可選或有預設值）
  lastLoginAt     DateTime? // 最後登入時間
  loginCount      Int       @default(0) // 登入次數
  loginAttempts   Int       @default(0) // 登入失敗次數
  lockedUntil     DateTime? // 帳號鎖定到期時間
  
  // 偏好設定（全部可選或有預設值）
  preferences     String?   // JSON 字串儲存用戶偏好設定
  newsletter      Boolean   @default(true) // 是否訂閱電子報
  smsNotification Boolean   @default(true) // 是否接收簡訊通知
  
  // 備註
  internalNote    String?   // 內部備註（只有管理員可見）
  
  // 時間戳記
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @default(now()) @updatedAt  // 加入預設值
  deletedAt       DateTime? // 軟刪除時間
  
  // 關聯
  orders              ShipmentOrder[]       @relation("CustomerOrders")
  parcelNotifications ParcelNotification[]  @relation("CustomerParcels")

  @@index([email])
  @@index([phone])
  @@index([isActive])
  @@index([memberLevel])
  @@index([createdAt])
  @@map("customers")
}

// ===== 訂單資料模型 =====
model ShipmentOrder {
  id                String    @id @default(cuid())
  
  // 收件人資訊
  recipientName     String    // 收件人姓名
  address           String    // 收件地址
  phone             String    // 收件電話
  email             String    @default("pending@example.com") // 電子郵件（電子發票用）
  lineNickname      String?   // LINE 暱稱
  
  // 證件與稅務
  idNumber          String?   // 身分證字號
  taxId             String?   // 統一編號
  
  // 訂單內容
  calculationResult String    // JSON 字串儲存計算結果
  totalAmount       Float?    // 訂單總金額
  currency          String    @default("TWD") // 貨幣類型
  
  // 訂單狀態
  status            String    @default("NEEDS_PURCHASE") 
  // 狀態值：NEEDS_PURCHASE, PURCHASED, IN_WAREHOUSE, NOT_IN_WAREHOUSE, 
  //        SHIPPED, IN_CUSTOMS, DELIVERY_COMPLETE, CANCELLED
  
  // 加值服務（全部可選或有預設值）
  additionalServices String?  // JSON 字串儲存加值服務資訊
  serviceQuoted      Boolean  @default(false) // 是否已報價加值服務
  serviceQuoteAmount Float?   // 加值服務報價金額
  serviceCompleted   Boolean  @default(false) // 加值服務是否完成
  
  // 物流資訊（全部可選）
  trackingNumber    String?   // 物流追蹤號碼
  shippingMethod    String?   // 運送方式
  estimatedDelivery DateTime? // 預計送達時間
  actualDelivery    DateTime? // 實際送達時間
  
  // 付款資訊（全部可選或有預設值）
  paymentStatus     String    @default("PENDING") // PENDING, PAID, FAILED, REFUNDED
  paymentMethod     String?   // 付款方式
  paidAt            DateTime? // 付款時間
  invoiceNumber     String?   // 發票號碼
  
  // 備註（全部可選）
  customerNote      String?   // 客戶備註
  adminNote         String?   // 管理員備註
  internalNote      String?   // 內部備註
  
  // 時間戳記
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @default(now()) @updatedAt  // 加入預設值
  completedAt       DateTime? // 訂單完成時間
  cancelledAt       DateTime? // 訂單取消時間
  
  // 關聯
  assignedToId      String?
  assignedTo        User?     @relation("AssignedOrders", fields: [assignedToId], references: [id])
  customerId        String?
  customer          Customer? @relation("CustomerOrders", fields: [customerId], references: [id])

  @@index([customerId])
  @@index([email])
  @@index([status])
  @@index([paymentStatus])
  @@index([createdAt])
  @@index([trackingNumber])
  @@map("shipment_orders")
}

// ===== 估價單資料模型 =====
model CalculationQuote {
  id                String    @id @default(cuid())
  calculationResult String    // JSON 字串儲存計算結果
  
  // 追蹤資訊（全部可選或有預設值）
  ipAddress         String?   // 建立者 IP
  userAgent         String?   // 建立者瀏覽器資訊
  referrer          String?   // 來源網址
  
  // 分享資訊（全部有預設值）
  shareCount        Int       @default(0) // 分享次數
  viewCount         Int       @default(0) // 查看次數
  lastViewedAt      DateTime? // 最後查看時間
  
  // 轉換追蹤（有預設值）
  convertedToOrder  Boolean   @default(false) // 是否已轉換為訂單
  orderId           String?   // 關聯的訂單 ID
  
  // 時間戳記
  createdAt         DateTime  @default(now())
  expiresAt         DateTime? // 估價單到期時間

  @@index([createdAt])
  @@index([convertedToOrder])
  @@map("calculation_quotes")
}

// ===== 包裹預報資料模型 =====
model ParcelNotification {
  id                String    @id @default(cuid())
  
  // 包裹資訊
  trackingNumber    String    // 物流單號
  logisticsCompany  String?   // 物流公司
  productName       String    // 商品名稱
  productLink       String?   // 商品連結
  productImages     String    @default("[]") // JSON array of image URLs
  quantity          Int       @default(1) // 數量
  weight            Float?    // 重量（公斤）
  value             Float?    // 申報價值
  
  // 狀態
  status            String    @default("PENDING") 
  // 狀態值：PENDING, CONFIRMED, ARRIVED, COMPLETED, CANCELLED
  
  // 台灣收件資料（全部可選）
  taiwanDelivery    String?   // JSON 字串儲存台灣收件資料
  taiwanTracking    String?   // 台灣段物流單號
  
  // 會員關聯
  customerId        String?
  customer          Customer? @relation("CustomerParcels", fields: [customerId], references: [id])
  
  // 非會員資訊（全部可選）
  guestEmail        String?   // 非會員的電子郵件
  guestPhone        String?   // 非會員的電話
  guestName         String?   // 非會員的姓名
  queryCode         String?   @unique // 非會員查詢碼
  
  // 備註（全部可選）
  note              String?   // 客戶備註
  adminNote         String?   // 管理員備註
  internalNote      String?   // 內部備註
  
  // 處理記錄（全部可選）
  processedBy       String?   // 處理人員 ID
  processedAt       DateTime? // 處理時間
  
  // 時間戳記
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @default(now()) @updatedAt  // 加入預設值
  confirmedAt       DateTime? // 確認時間
  arrivedAt         DateTime? // 到倉時間
  completedAt       DateTime? // 完成時間
  cancelledAt       DateTime? // 取消時間
  
  @@index([customerId])
  @@index([trackingNumber])
  @@index([status])
  @@index([guestEmail])
  @@index([queryCode])
  @@index([createdAt])
  @@map("parcel_notifications")
}