// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"  // 使用 PostgreSQL
  url      = env("DATABASE_URL")
}

// 用於後台管理系統的「使用者(員工)」資料模型
model User {
  id            String    @id @default(cuid())
  username      String    @unique // 員工登入帳號，不可重複
  passwordHash  String    // 加密後的密碼
  role          String    @default("OPERATOR") // 角色，例如 OPERATOR 或 ADMIN
  createdAt     DateTime  @default(now())

  // 建立 User 和 ShipmentOrder 之間的一對多關聯
  assignedOrders ShipmentOrder[] @relation("AssignedOrders")
  
  // 新增：審計日誌關聯
  auditLogs     AuditLog[]      @relation("PerformedActions")

  @@map("users")
}

// 客戶會員資料模型
model Customer {
  id                 String    @id @default(cuid())
  email              String    @unique // 會員電子郵件，用於登入
  passwordHash       String    // 加密後的密碼
  name               String    // 會員姓名
  phone              String?   // 聯絡電話
  lineNickname       String?   // LINE 暱稱
  defaultAddress     String?   // 預設地址
  idNumber           String?   // 身分證字號
  isActive           Boolean   @default(true) // 帳號狀態
  needPasswordChange Boolean   @default(false) // 新增：是否需要強制修改密碼
  passwordResetAt    DateTime? // 新增：密碼重設時間
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  // 建立 Customer 和 ShipmentOrder 之間的一對多關聯
  orders ShipmentOrder[] @relation("CustomerOrders")

  @@index([email])
  @@index([phone])
  @@map("customers")
}

// 客戶提交的「正式訂單」資料模型
model ShipmentOrder {
  id                String    @id @default(cuid())
  createdAt         DateTime  @default(now())
  lineNickname      String?
  recipientName     String
  address           String
  phone             String
  idNumber          String?
  calculationResult String    // SQLite 改用 String 儲存 JSON

  // 用於後台追蹤的欄位
  status            String    @default("NEEDS_PURCHASE") // 訂單進度狀態（改用 String）
  
  // 加值服務欄位 (新增這三行)
  additionalServices String?  // JSON 字串儲存加值服務資訊
  serviceQuoted      Boolean  @default(false) // 是否已報價加值服務
  serviceQuoteAmount Float?   // 加值服務報價金額
  
  // 指派給哪位員工 (選填)
  assignedToId      String?
  assignedTo        User?       @relation("AssignedOrders", fields: [assignedToId], references: [id])

  // 關聯到會員 (選填，因為非會員也可以下單)
  customerId        String?
  customer          Customer?   @relation("CustomerOrders", fields: [customerId], references: [id])

  @@index([customerId])
  @@map("shipment_orders")
}

// 用於分享功能的「估價單」資料模型
model CalculationQuote {
  id                String    @id @default(cuid())
  createdAt         DateTime  @default(now())
  calculationResult String    // SQLite 改用 String 儲存 JSON

  @@map("calculation_quotes")
}

// 新增：審計日誌表（用於記錄重要操作）
model AuditLog {
  id            String   @id @default(cuid())
  action        String   // 操作類型 (如: PASSWORD_RESET, STATUS_CHANGE)
  targetType    String   // 目標類型 (如: CUSTOMER, ORDER)
  targetId      String   // 目標ID
  performedById String   // 執行操作的管理員ID
  performedBy   User     @relation("PerformedActions", fields: [performedById], references: [id])
  details       String?  // JSON 格式的額外資訊
  ipAddress     String?  // 操作者的IP位址
  userAgent     String?  // 操作者的瀏覽器資訊
  createdAt     DateTime @default(now())

  @@index([action])
  @@index([targetId])
  @@index([performedById])
  @@map("audit_logs")
}