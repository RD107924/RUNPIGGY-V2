// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"  // 使用 PostgreSQL
  url      = env("DATABASE_URL")
}

// 用於後台管理系統的「使用者(員工)」資料模型
model User {
  id            String    @id @default(cuid())
  username      String    @unique // 員工登入帳號，不可重複
  passwordHash  String    // 加密後的密碼
  role          String    @default("OPERATOR") // 角色，例如 OPERATOR 或 ADMIN
  createdAt     DateTime  @default(now())

  // 建立 User 和 ShipmentOrder 之間的一對多關聯
  assignedOrders ShipmentOrder[] @relation("AssignedOrders")

  @@map("users")
}

// 客戶會員資料模型
model Customer {
  id              String    @id @default(cuid())
  email           String    @unique // 會員電子郵件，用於登入
  passwordHash    String    // 加密後的密碼
  name            String    // 會員姓名
  phone           String?   // 聯絡電話
  lineNickname    String?   // LINE 暱稱
  defaultAddress  String?   // 預設地址
  idNumber        String?   // 身分證字號
  isActive        Boolean   @default(true) // 帳號狀態
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // 建立 Customer 和 ShipmentOrder 之間的一對多關聯
  orders ShipmentOrder[] @relation("CustomerOrders")
  
  // 建立 Customer 和 ParcelNotification 之間的一對多關聯
  parcelNotifications ParcelNotification[] @relation("CustomerParcels")

  @@index([email])
  @@index([phone])
  @@map("customers")
}

// 客戶提交的「正式訂單」資料模型
model ShipmentOrder {
  id                String    @id @default(cuid())
  createdAt         DateTime  @default(now())
  lineNickname      String?
  recipientName     String
  address           String
  phone             String
  idNumber          String?
  calculationResult String    // SQLite 改用 String 儲存 JSON

  // 用於後台追蹤的欄位
  status            String    @default("NEEDS_PURCHASE") // 訂單進度狀態（改用 String）
  
  // 加值服務欄位
  additionalServices String?  // JSON 字串儲存加值服務資訊
  serviceQuoted      Boolean  @default(false) // 是否已報價加值服務
  serviceQuoteAmount Float?   // 加值服務報價金額
  
  // 指派給哪位員工 (選填)
  assignedToId      String?
  assignedTo        User?       @relation("AssignedOrders", fields: [assignedToId], references: [id])

  // 關聯到會員 (選填，因為非會員也可以下單)
  customerId        String?
  customer          Customer?   @relation("CustomerOrders", fields: [customerId], references: [id])

  @@index([customerId])
  @@map("shipment_orders")
}

// 用於分享功能的「估價單」資料模型
model CalculationQuote {
  id                String    @id @default(cuid())
  createdAt         DateTime  @default(now())
  calculationResult String    // SQLite 改用 String 儲存 JSON

  @@map("calculation_quotes")
}

// 新增：包裹預報資料模型
model ParcelNotification {
  id                String    @id @default(cuid())
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  // 大陸物流資訊
  trackingNumber    String    // 大陸物流單號
  logisticsCompany  String?   // 物流公司名稱
  
  // 商品資訊
  productName       String    // 商品名稱
  productLink       String?   // 商品鏈接
  productImages     String    // JSON 陣列儲存圖片 URL
  quantity          Int       @default(1) // 數量
  note              String?   // 備註
  
  // 預報狀態
  status            String    @default("PENDING") // PENDING, CONFIRMED, ARRIVED, COMPLETED, CANCELLED
  
  // 關聯到會員
  customerId        String
  customer          Customer  @relation("CustomerParcels", fields: [customerId], references: [id])
  
  // 管理員備註
  adminNote         String?   // 管理員備註
  confirmedAt       DateTime? // 確認時間
  arrivedAt         DateTime? // 到達倉庫時間
  
  @@index([customerId])
  @@index([trackingNumber])
  @@index([status])
  @@map("parcel_notifications")
}