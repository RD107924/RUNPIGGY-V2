// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ===== 員工/管理者資料模型 =====
model User {
  id            String    @id @default(cuid())
  username      String    @unique
  passwordHash  String
  role          String    @default("OPERATOR") // OPERATOR, ADMIN, SUPER_ADMIN
  
  // 員工資訊
  fullName      String?
  email         String?
  phone         String?
  department    String?
  isActive      Boolean   @default(true)
  
  // 登入與安全
  lastLoginAt   DateTime?
  loginAttempts Int       @default(0)
  lockedUntil   DateTime?
  
  // 時間戳記
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @default(now()) @updatedAt
  
  // 關聯
  assignedOrders      ShipmentOrder[]      @relation("AssignedOrders")
  operationLogs       OrderOperationLog[]  @relation("UserOperations")  // 新增

  @@index([username])
  @@index([role])
  @@index([isActive])
  @@map("users")
}

// ===== 客戶會員資料模型 =====
model Customer {
  id              String    @id @default(cuid())
  email           String    @unique
  passwordHash    String
  
  // 基本資料
  name            String
  phone           String?
  lineNickname    String?
  defaultAddress  String?
  idNumber        String?
  taxId           String?
  
  // 會員狀態與安全
  isActive        Boolean   @default(true)
  emailVerified   Boolean   @default(false)
  phoneVerified   Boolean   @default(false)
  
  // 密碼管理
  needPasswordChange Boolean @default(false)
  passwordResetAt    DateTime?
  passwordResetToken String?
  passwordResetExpiry DateTime?
  
  // 會員等級與積分
  memberLevel     String    @default("BASIC") // BASIC, SILVER, GOLD, PLATINUM
  points          Int       @default(0)
  totalSpent      Float     @default(0)
  
  // 登入記錄
  lastLoginAt     DateTime?
  loginCount      Int       @default(0)
  loginAttempts   Int       @default(0)
  lockedUntil     DateTime?
  
  // 偏好設定
  preferences     String?
  newsletter      Boolean   @default(true)
  smsNotification Boolean   @default(true)
  
  // 備註
  internalNote    String?
  
  // 時間戳記
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @default(now()) @updatedAt
  deletedAt       DateTime?
  
  // 關聯
  orders              ShipmentOrder[]       @relation("CustomerOrders")
  parcelNotifications ParcelNotification[]  @relation("CustomerParcels")

  @@index([email])
  @@index([phone])
  @@index([isActive])
  @@index([memberLevel])
  @@index([createdAt])
  @@map("customers")
}

// ===== 訂單資料模型（增強版）=====
model ShipmentOrder {
  id                String    @id @default(cuid())
  
  // 收件人資訊
  recipientName     String
  address           String
  phone             String
  email             String    @default("pending@example.com")
  lineNickname      String?
  
  // 證件與稅務
  idNumber          String?
  taxId             String?
  
  // 訂單內容
  calculationResult String    // 原始計算結果
  totalAmount       Float?
  currency          String    @default("TWD")
  
  // 訂單狀態
  status            String    @default("NEEDS_PURCHASE")
  
  // 加值服務
  additionalServices String?
  serviceQuoted      Boolean  @default(false)
  serviceQuoteAmount Float?
  serviceCompleted   Boolean  @default(false)
  
  // ===== 新增：包裹轉訂單相關欄位 =====
  // 來源包裹
  sourceParcelId    String?   @unique
  sourceParcel      ParcelNotification? @relation("ParcelToOrder", fields: [sourceParcelId], references: [id])
  
  // 實際入庫測量資料
  actualWeight      Float?    // 實際重量（公斤）
  actualLength      Float?    // 實際長度（公分）
  actualWidth       Float?    // 實際寬度（公分）
  actualHeight      Float?    // 實際高度（公分）
  actualCbm         Float?    // 實際材積
  
  // 加強保護服務
  protectionNeeded  Boolean   @default(false)
  protectionPrice   Float?    // 加強保護費用
  protectionNote    String?   // 加強保護說明
  
  // 調整後的最終報價
  finalQuoteData    String?   // JSON：包含所有費用明細
  finalTotalAmount  Float?    // 最終總金額
  quoteNote         String?   // 報價備註說明
  quoteValidUntil   DateTime? // 報價有效期限
  
  // 分享功能
  shareToken        String?   @unique @default(cuid())
  shareCreatedAt    DateTime? // 分享連結建立時間
  shareViewCount    Int       @default(0)
  shareLastViewedAt DateTime? // 最後查看時間
  
  // ===== 結束新增區塊 =====
  
  // 物流資訊
  trackingNumber    String?
  shippingMethod    String?
  estimatedDelivery DateTime?
  actualDelivery    DateTime?
  
  // 付款資訊
  paymentStatus     String    @default("PENDING")
  paymentMethod     String?
  paidAt            DateTime?
  invoiceNumber     String?
  
  // 備註
  customerNote      String?
  adminNote         String?
  internalNote      String?
  
  // 時間戳記
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @default(now()) @updatedAt
  completedAt       DateTime?
  cancelledAt       DateTime?
  
  // 關聯
  assignedToId      String?
  assignedTo        User?     @relation("AssignedOrders", fields: [assignedToId], references: [id])
  customerId        String?
  customer          Customer? @relation("CustomerOrders", fields: [customerId], references: [id])
  
  // 新增：操作記錄關聯
  operationLogs     OrderOperationLog[] @relation("OrderOperations")

  @@index([customerId])
  @@index([email])
  @@index([status])
  @@index([paymentStatus])
  @@index([createdAt])
  @@index([trackingNumber])
  @@index([shareToken])        // 新增索引
  @@index([sourceParcelId])     // 新增索引
  @@map("shipment_orders")
}

// ===== 估價單資料模型 =====
model CalculationQuote {
  id                String    @id @default(cuid())
  calculationResult String
  
  // 追蹤資訊
  ipAddress         String?
  userAgent         String?
  referrer          String?
  
  // 分享資訊
  shareCount        Int       @default(0)
  viewCount         Int       @default(0)
  lastViewedAt      DateTime?
  
  // 轉換追蹤
  convertedToOrder  Boolean   @default(false)
  orderId           String?
  
  // 時間戳記
  createdAt         DateTime  @default(now())
  expiresAt         DateTime?

  @@index([createdAt])
  @@index([convertedToOrder])
  @@map("calculation_quotes")
}

// ===== 包裹預報資料模型（增強版）=====
model ParcelNotification {
  id                String    @id @default(cuid())
  convertedOrderId  String?
  // 包裹資訊
  trackingNumber    String
  logisticsCompany  String?
  productName       String
  productLink       String?
  productImages     String    @default("[]")
  quantity          Int       @default(1)
  weight            Float?
  value             Float?
  
  // 狀態
  status            String    @default("PENDING")
  
  // ===== 新增：訂單轉換相關 =====
  // 轉換狀態
  isConverted       Boolean   @default(false)  // 是否已轉換為訂單
  convertedAt       DateTime? // 轉換時間
  convertedBy       String?   // 轉換操作員 ID
  
  // 關聯到正式訂單（反向關聯）
  convertedOrder    ShipmentOrder? @relation("ParcelToOrder")
  
  // ===== 結束新增區塊 =====
  
  // 台灣收件資料
  taiwanDelivery    String?
  taiwanTracking    String?
  
  // 會員關聯
  customerId        String?
  customer          Customer? @relation("CustomerParcels", fields: [customerId], references: [id])
  
  // 非會員資訊
  guestEmail        String?
  guestPhone        String?
  guestName         String?
  queryCode         String?   @unique
  
  // 備註
  note              String?
  adminNote         String?
  internalNote      String?
  
  // 處理記錄
  processedBy       String?
  processedAt       DateTime?
  
  // 時間戳記
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @default(now()) @updatedAt
  confirmedAt       DateTime?
  arrivedAt         DateTime?
  completedAt       DateTime?
  cancelledAt       DateTime?
  
  @@index([customerId])
  @@index([trackingNumber])
  @@index([status])
  @@index([guestEmail])
  @@index([queryCode])
  @@index([createdAt])
  @@index([isConverted])      // 新增索引
  @@map("parcel_notifications")
}

// ===== 新增：訂單操作記錄表 =====
model OrderOperationLog {
  id              String    @id @default(cuid())
  
  // 關聯
  orderId         String
  order           ShipmentOrder @relation("OrderOperations", fields: [orderId], references: [id])
  operatorId      String
  operator        User @relation("UserOperations", fields: [operatorId], references: [id])
  
  // 操作資訊
  action          String    // CONVERT_FROM_PARCEL, UPDATE_DIMENSION, UPDATE_PRICE, UPDATE_PROTECTION, GENERATE_SHARE, UPDATE_STATUS
  previousValue   String?   // JSON：操作前的值
  newValue        String?   // JSON：操作後的值
  details         String?   // JSON：額外詳情
  note            String?   // 操作備註
  
  // 客戶端資訊
  ipAddress       String?   // 操作者 IP
  userAgent       String?   // 操作者瀏覽器
  
  // 時間戳記
  createdAt       DateTime  @default(now())
  
  @@index([orderId])
  @@index([operatorId])
  @@index([action])
  @@index([createdAt])
  @@map("order_operation_logs")
}