<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>包裹預報 - 小跑豬</title>
    <link rel="icon" type="image/png" href="/assets/logo.png" />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Helvetica Neue", Arial, "Heiti TC", "Microsoft JhengHei",
          sans-serif;
        background-color: #f4f7f9;
        color: #333;
        padding: 20px;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        background-color: #fff;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      }

      .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        flex-wrap: wrap;
        gap: 15px;
      }

      .logo {
        max-width: 120px;
        height: auto;
      }

      h1 {
        color: #1a73e8;
        font-size: 2em;
      }

      .btn {
        padding: 12px 25px;
        font-size: 16px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        transition: background-color 0.3s;
        text-decoration: none;
        display: inline-block;
      }

      .btn-primary {
        background-color: #1a73e8;
        color: white;
      }

      .btn-primary:hover {
        background-color: #1558b8;
      }

      .btn-secondary {
        background-color: #2ecc71;
        color: white;
      }

      .btn-secondary:hover {
        background-color: #27ae60;
      }

      .btn-danger {
        background-color: #e74c3c;
        color: white;
      }

      .btn-danger:hover {
        background-color: #c0392b;
      }

      /* 預報表單樣式 */
      .notification-form {
        background-color: #f8f9fa;
        padding: 30px;
        border-radius: 8px;
        margin-bottom: 30px;
      }

      .form-group {
        margin-bottom: 20px;
      }

      .form-group label {
        display: block;
        margin-bottom: 8px;
        color: #555;
        font-weight: bold;
      }

      .form-group input[type="text"],
      .form-group input[type="number"],
      .form-group input[type="url"],
      .form-group textarea,
      .form-group select {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 16px;
      }

      .form-group textarea {
        resize: vertical;
        min-height: 80px;
      }

      .required {
        color: #e74c3c;
      }

      /* 圖片上傳區域 */
      .image-upload-area {
        border: 2px dashed #ddd;
        border-radius: 8px;
        padding: 20px;
        text-align: center;
        background-color: #fafafa;
        cursor: pointer;
        transition: all 0.3s;
      }

      .image-upload-area:hover {
        border-color: #1a73e8;
        background-color: #f0f8ff;
      }

      .image-preview-container {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 15px;
      }

      .image-preview {
        position: relative;
        width: 120px;
        height: 120px;
        border: 1px solid #ddd;
        border-radius: 5px;
        overflow: hidden;
      }

      .image-preview img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .image-preview .remove-btn {
        position: absolute;
        top: 5px;
        right: 5px;
        background-color: rgba(231, 76, 60, 0.9);
        color: white;
        border: none;
        border-radius: 50%;
        width: 25px;
        height: 25px;
        cursor: pointer;
        font-size: 16px;
        line-height: 1;
      }

      /* 包裹列表 */
      .parcel-list {
        margin-top: 30px;
      }

      .parcel-tabs {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        border-bottom: 2px solid #e9ecef;
      }

      .tab-btn {
        padding: 10px 20px;
        background: none;
        border: none;
        cursor: pointer;
        font-size: 16px;
        color: #666;
        border-bottom: 3px solid transparent;
        transition: all 0.3s;
      }

      .tab-btn.active {
        color: #1a73e8;
        border-bottom-color: #1a73e8;
      }

      .parcel-card {
        background-color: #fff;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 15px;
        transition: box-shadow 0.3s;
      }

      .parcel-card:hover {
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      }

      .parcel-header {
        display: flex;
        justify-content: space-between;
        align-items: start;
        margin-bottom: 15px;
      }

      .parcel-info h3 {
        color: #333;
        margin-bottom: 5px;
      }

      .parcel-tracking {
        color: #666;
        font-size: 14px;
      }

      .status-badge {
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: bold;
      }

      .status-PENDING {
        background-color: #ffc107;
        color: #333;
      }

      .status-CONFIRMED {
        background-color: #17a2b8;
        color: white;
      }

      .status-ARRIVED {
        background-color: #6c757d;
        color: white;
      }

      .status-COMPLETED {
        background-color: #28a745;
        color: white;
      }

      .status-CANCELLED {
        background-color: #dc3545;
        color: white;
      }

      .parcel-images {
        display: flex;
        gap: 10px;
        margin: 15px 0;
        flex-wrap: wrap;
      }

      .parcel-image {
        width: 80px;
        height: 80px;
        border-radius: 5px;
        overflow: hidden;
        cursor: pointer;
        border: 1px solid #ddd;
      }

      .parcel-image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .parcel-actions {
        display: flex;
        gap: 10px;
        margin-top: 15px;
      }

      .empty-state {
        text-align: center;
        padding: 40px;
        color: #999;
      }

      .empty-state svg {
        width: 100px;
        height: 100px;
        margin-bottom: 20px;
        opacity: 0.3;
      }

      /* Modal */
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.8);
        align-items: center;
        justify-content: center;
        z-index: 2000;
      }

      .modal.active {
        display: flex;
      }

      .modal img {
        max-width: 90%;
        max-height: 90vh;
        object-fit: contain;
      }

      .modal-close {
        position: absolute;
        top: 20px;
        right: 40px;
        color: white;
        font-size: 40px;
        cursor: pointer;
      }

      .message {
        padding: 15px;
        margin-bottom: 20px;
        border-radius: 5px;
        display: none;
      }

      .message.success {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
        display: block;
      }

      .message.error {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
        display: block;
      }

      @media (max-width: 768px) {
        .container {
          padding: 15px;
        }

        .header {
          flex-direction: column;
          text-align: center;
        }

        h1 {
          font-size: 1.5em;
        }

        .parcel-header {
          flex-direction: column;
          gap: 10px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <img src="/assets/logo.png" alt="小跑豬 LOGO" class="logo" />
        <h1>包裹預報系統</h1>
        <div>
          <a href="/customer.html" class="btn btn-secondary">返回會員中心</a>
          <button id="logoutBtn" class="btn btn-danger">登出</button>
        </div>
      </div>

      <div id="messageBox" class="message"></div>

      <!-- 預報表單 -->
      <div class="notification-form">
        <h2>新增包裹預報</h2>
        <form id="parcelForm">
          <div class="form-group">
            <label for="trackingNumber"
              >大陸物流單號 <span class="required">*</span></label
            >
            <input
              type="text"
              id="trackingNumber"
              required
              placeholder="請輸入物流單號"
            />
          </div>

          <div class="form-group">
            <label for="logisticsCompany">物流公司</label>
            <select id="logisticsCompany">
              <option value="">請選擇物流公司</option>
              <option value="順豐速運">順豐速運</option>
              <option value="圓通速遞">圓通速遞</option>
              <option value="中通快遞">中通快遞</option>
              <option value="申通快遞">申通快遞</option>
              <option value="韻達快遞">韻達快遞</option>
              <option value="京東物流">京東物流</option>
              <option value="極兔速遞">極兔速遞</option>
              <option value="德邦快遞">德邦快遞</option>
              <option value="其他">其他</option>
            </select>
          </div>

          <div class="form-group">
            <label for="productName"
              >商品名稱 <span class="required">*</span></label
            >
            <input
              type="text"
              id="productName"
              required
              placeholder="請輸入商品名稱"
            />
          </div>

          <div class="form-group">
            <label for="productLink">商品鏈接</label>
            <input type="url" id="productLink" placeholder="https://..." />
          </div>

          <div class="form-group">
            <label for="quantity">數量</label>
            <input type="number" id="quantity" min="1" value="1" />
          </div>

          <div class="form-group">
            <label for="note">備註</label>
            <textarea id="note" placeholder="如有特殊要求請在此說明"></textarea>
          </div>

          <div class="form-group">
            <label>商品圖片（最多5張）</label>
            <div
              class="image-upload-area"
              onclick="document.getElementById('imageInput').click()"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="48"
                height="48"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2" />
                <circle cx="8.5" cy="8.5" r="1.5" />
                <polyline points="21 15 16 10 5 21" />
              </svg>
              <p>點擊或拖曳圖片到此處上傳</p>
              <p style="font-size: 12px; color: #999">
                支援 JPG, PNG, GIF, WEBP 格式，單檔最大 5MB
              </p>
            </div>
            <input
              type="file"
              id="imageInput"
              accept="image/*"
              multiple
              style="display: none"
            />
            <div
              id="imagePreviewContainer"
              class="image-preview-container"
            ></div>
          </div>

          <button type="submit" class="btn btn-primary" style="width: 100%">
            提交預報
          </button>
        </form>
      </div>

      <!-- 包裹列表 -->
      <div class="parcel-list">
        <h2>我的包裹預報</h2>

        <div class="parcel-tabs">
          <button class="tab-btn active" data-status="all">全部</button>
          <button class="tab-btn" data-status="PENDING">待確認</button>
          <button class="tab-btn" data-status="CONFIRMED">已確認</button>
          <button class="tab-btn" data-status="ARRIVED">已到倉</button>
          <button class="tab-btn" data-status="COMPLETED">已完成</button>
          <button class="tab-btn" data-status="CANCELLED">已取消</button>
        </div>

        <div id="parcelListContainer">
          <div class="empty-state">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <path
                d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"
              />
              <polyline points="3.27 6.96 12 12.01 20.73 6.96" />
              <line x1="12" y1="22.08" x2="12" y2="12" />
            </svg>
            <p>暫無包裹預報記錄</p>
          </div>
        </div>
      </div>
    </div>

    <!-- 圖片預覽 Modal -->
    <div id="imageModal" class="modal">
      <span class="modal-close" onclick="closeImageModal()">&times;</span>
      <img id="modalImage" src="" alt="" />
    </div>

    <script>
      const API_BASE = "/api/parcels";
      const customerToken = localStorage.getItem("customerToken");
      let selectedImages = [];
      let currentStatus = "all";

      // 頁面載入時檢查登入狀態
      window.addEventListener("DOMContentLoaded", () => {
        if (!customerToken) {
          alert("請先登入");
          window.location.href = "/customer.html";
          return;
        }

        loadParcels();
        setupEventListeners();
      });

      // 設定事件監聽器
      function setupEventListeners() {
        // 表單提交
        document
          .getElementById("parcelForm")
          .addEventListener("submit", handleSubmit);

        // 圖片上傳
        document
          .getElementById("imageInput")
          .addEventListener("change", handleImageSelect);

        // 拖放上傳
        const uploadArea = document.querySelector(".image-upload-area");
        uploadArea.addEventListener("dragover", (e) => {
          e.preventDefault();
          uploadArea.style.backgroundColor = "#e9f5ff";
        });

        uploadArea.addEventListener("dragleave", () => {
          uploadArea.style.backgroundColor = "#fafafa";
        });

        uploadArea.addEventListener("drop", (e) => {
          e.preventDefault();
          uploadArea.style.backgroundColor = "#fafafa";
          handleDroppedFiles(e.dataTransfer.files);
        });

        // 標籤切換
        document.querySelectorAll(".tab-btn").forEach((btn) => {
          btn.addEventListener("click", (e) => {
            document
              .querySelectorAll(".tab-btn")
              .forEach((b) => b.classList.remove("active"));
            e.target.classList.add("active");
            currentStatus = e.target.dataset.status;
            loadParcels();
          });
        });

        // 登出
        document.getElementById("logoutBtn").addEventListener("click", () => {
          if (confirm("確定要登出嗎？")) {
            localStorage.removeItem("customerToken");
            window.location.href = "/customer.html";
          }
        });
      }

      // 處理圖片選擇
      function handleImageSelect(e) {
        handleDroppedFiles(e.target.files);
      }

      // 處理拖放的檔案
      function handleDroppedFiles(files) {
        const validFiles = Array.from(files).filter((file) => {
          if (!file.type.startsWith("image/")) {
            showMessage("只能上傳圖片檔案", "error");
            return false;
          }
          if (file.size > 5 * 1024 * 1024) {
            showMessage(`檔案 ${file.name} 超過 5MB 限制`, "error");
            return false;
          }
          return true;
        });

        if (selectedImages.length + validFiles.length > 5) {
          showMessage("最多只能上傳 5 張圖片", "error");
          return;
        }

        validFiles.forEach((file) => {
          selectedImages.push(file);
          displayImagePreview(file);
        });
      }

      // 顯示圖片預覽
      function displayImagePreview(file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          const container = document.getElementById("imagePreviewContainer");
          const preview = document.createElement("div");
          preview.className = "image-preview";
          preview.innerHTML = `
                    <img src="${e.target.result}" alt="${file.name}">
                    <button class="remove-btn" onclick="removeImage(${
                      selectedImages.length - 1
                    })">&times;</button>
                `;
          container.appendChild(preview);
        };
        reader.readAsDataURL(file);
      }

      // 移除圖片
      function removeImage(index) {
        selectedImages.splice(index, 1);
        updateImagePreviews();
      }

      // 更新圖片預覽
      function updateImagePreviews() {
        const container = document.getElementById("imagePreviewContainer");
        container.innerHTML = "";
        selectedImages.forEach((file, index) => {
          const reader = new FileReader();
          reader.onload = (e) => {
            const preview = document.createElement("div");
            preview.className = "image-preview";
            preview.innerHTML = `
                        <img src="${e.target.result}" alt="${file.name}">
                        <button class="remove-btn" onclick="removeImage(${index})">&times;</button>
                    `;
            container.appendChild(preview);
          };
          reader.readAsDataURL(file);
        });
      }

      // 提交表單 - 修復版本
      async function handleSubmit(e) {
        e.preventDefault();

        // 判斷是否有圖片
        const hasImages = selectedImages.length > 0;

        try {
          let response;

          if (hasImages) {
            // 有圖片：使用 FormData 和 /create-with-images 端點
            console.log("提交包含圖片的預報...");

            const formData = new FormData();
            formData.append(
              "trackingNumber",
              document.getElementById("trackingNumber").value
            );
            formData.append(
              "logisticsCompany",
              document.getElementById("logisticsCompany").value
            );
            formData.append(
              "productName",
              document.getElementById("productName").value
            );
            formData.append(
              "productLink",
              document.getElementById("productLink").value
            );
            formData.append(
              "quantity",
              document.getElementById("quantity").value || "1"
            );
            formData.append("note", document.getElementById("note").value);

            // 添加圖片
            selectedImages.forEach((image) => {
              formData.append("images", image);
            });

            response = await fetch(`${API_BASE}/create-with-images`, {
              method: "POST",
              headers: {
                Authorization: `Bearer ${customerToken}`,
                // 注意：FormData 不需要設定 Content-Type
              },
              body: formData,
            });
          } else {
            // 沒有圖片：使用 JSON 和 /create-json 端點
            console.log("提交不含圖片的預報...");

            const requestData = {
              trackingNumber: document.getElementById("trackingNumber").value,
              logisticsCompany:
                document.getElementById("logisticsCompany").value,
              productName: document.getElementById("productName").value,
              productLink: document.getElementById("productLink").value,
              quantity: document.getElementById("quantity").value || "1",
              note: document.getElementById("note").value,
            };

            response = await fetch(`${API_BASE}/create-json`, {
              method: "POST",
              headers: {
                Authorization: `Bearer ${customerToken}`,
                "Content-Type": "application/json",
              },
              body: JSON.stringify(requestData),
            });
          }

          // 處理回應
          const data = await response.json();

          if (response.ok) {
            showMessage("包裹預報成功！", "success");
            document.getElementById("parcelForm").reset();
            selectedImages = [];
            document.getElementById("imagePreviewContainer").innerHTML = "";
            loadParcels();
          } else {
            console.error("預報失敗:", data);
            showMessage(data.error || "預報失敗", "error");
          }
        } catch (error) {
          console.error("提交錯誤:", error);
          showMessage("網路錯誤，請稍後再試", "error");
        }
      }

      // 載入包裹列表
      async function loadParcels() {
        try {
          let url = `${API_BASE}/my-parcels`;
          if (currentStatus !== "all") {
            url += `?status=${currentStatus}`;
          }

          const response = await fetch(url, {
            headers: {
              Authorization: `Bearer ${customerToken}`,
            },
          });

          if (response.ok) {
            const parcels = await response.json();
            displayParcels(parcels);
          }
        } catch (error) {
          console.error("載入包裹失敗:", error);
        }
      }

      // 顯示包裹列表
      function displayParcels(parcels) {
        const container = document.getElementById("parcelListContainer");

        if (parcels.length === 0) {
          container.innerHTML = `
                    <div class="empty-state">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
                            <polyline points="3.27 6.96 12 12.01 20.73 6.96"/>
                            <line x1="12" y1="22.08" x2="12" y2="12"/>
                        </svg>
                        <p>暫無包裹預報記錄</p>
                    </div>
                `;
          return;
        }

        const statusMap = {
          PENDING: "待確認",
          CONFIRMED: "已確認",
          ARRIVED: "已到倉",
          COMPLETED: "已完成",
          CANCELLED: "已取消",
        };

        container.innerHTML = parcels
          .map(
            (parcel) => `
                <div class="parcel-card">
                    <div class="parcel-header">
                        <div class="parcel-info">
                            <h3>${parcel.productName}</h3>
                            <p class="parcel-tracking">物流單號: ${
                              parcel.trackingNumber
                            }</p>
                            ${
                              parcel.logisticsCompany
                                ? `<p>物流公司: ${parcel.logisticsCompany}</p>`
                                : ""
                            }
                            <p>數量: ${parcel.quantity}</p>
                            <p>預報時間: ${new Date(
                              parcel.createdAt
                            ).toLocaleString()}</p>
                        </div>
                        <span class="status-badge status-${parcel.status}">${
              statusMap[parcel.status]
            }</span>
                    </div>
                    
                    ${
                      parcel.productLink
                        ? `
                        <p>商品鏈接: <a href="${parcel.productLink}" target="_blank">${parcel.productLink}</a></p>
                    `
                        : ""
                    }
                    
                    ${parcel.note ? `<p>備註: ${parcel.note}</p>` : ""}
                    
                    ${
                      parcel.adminNote
                        ? `
                        <div style="background-color: #fff3cd; padding: 10px; border-radius: 5px; margin: 10px 0;">
                            <strong>管理員備註:</strong> ${parcel.adminNote}
                        </div>
                    `
                        : ""
                    }
                    
                    ${
                      parcel.productImages && parcel.productImages.length > 0
                        ? `
                        <div class="parcel-images">
                            ${parcel.productImages
                              .map(
                                (img) => `
                                <div class="parcel-image" onclick="showImage('${img}')">
                                    <img src="${img}" alt="商品圖片">
                                </div>
                            `
                              )
                              .join("")}
                        </div>
                    `
                        : ""
                    }
                    
                    ${
                      parcel.status === "PENDING"
                        ? `
                        <div class="parcel-actions">
                            <button class="btn btn-danger" onclick="cancelParcel('${parcel.id}')">取消預報</button>
                        </div>
                    `
                        : ""
                    }
                    
                    ${
                      parcel.confirmedAt
                        ? `<p style="color: #17a2b8;">確認時間: ${new Date(
                            parcel.confirmedAt
                          ).toLocaleString()}</p>`
                        : ""
                    }
                    ${
                      parcel.arrivedAt
                        ? `<p style="color: #6c757d;">到倉時間: ${new Date(
                            parcel.arrivedAt
                          ).toLocaleString()}</p>`
                        : ""
                    }
                </div>
            `
          )
          .join("");
      }

      // 取消包裹預報
      async function cancelParcel(id) {
        if (!confirm("確定要取消這個包裹預報嗎？")) {
          return;
        }

        try {
          const response = await fetch(`${API_BASE}/my-parcels/${id}/cancel`, {
            method: "PUT",
            headers: {
              Authorization: `Bearer ${customerToken}`,
            },
          });

          if (response.ok) {
            showMessage("包裹預報已取消", "success");
            loadParcels();
          } else {
            const error = await response.json();
            showMessage(error.error || "取消失敗", "error");
          }
        } catch (error) {
          showMessage("網路錯誤，請稍後再試", "error");
        }
      }

      // 顯示圖片
      function showImage(url) {
        document.getElementById("modalImage").src = url;
        document.getElementById("imageModal").classList.add("active");
      }

      // 關閉圖片 Modal
      function closeImageModal() {
        document.getElementById("imageModal").classList.remove("active");
      }

      // 顯示訊息
      function showMessage(text, type) {
        const messageBox = document.getElementById("messageBox");
        messageBox.textContent = text;
        messageBox.className = `message ${type}`;
        setTimeout(() => {
          messageBox.className = "message";
        }, 5000);
      }
    </script>
  </body>
</html>
