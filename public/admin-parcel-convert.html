<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>åŒ…è£¹è½‰è¨‚å–® - ç®¡ç†å¾Œå°</title>
    <link rel="icon" type="image/png" href="/assets/logo.png" />
    <link rel="stylesheet" href="/style.css" />
    <style>
      /* ä¸»å®¹å™¨ */
      .convert-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }

      /* é ‚éƒ¨æ¨™é¡Œå€ */
      .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 2px solid #e9ecef;
      }

      .page-title {
        color: #1a73e8;
        font-size: 2em;
        margin: 0;
      }

      .header-actions {
        display: flex;
        gap: 10px;
      }

      .header-actions button {
        padding: 10px 20px;
        font-size: 14px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        transition: background-color 0.3s;
      }

      .btn-back {
        background-color: #7f8c8d;
        color: white;
      }

      .btn-back:hover {
        background-color: #596164;
      }

      /* ä¸»è¦å…§å®¹å€ */
      .main-content {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 30px;
        margin-bottom: 30px;
      }

      /* è³‡è¨Šå¡ç‰‡ */
      .info-card {
        background: white;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      }

      .info-card h3 {
        color: #333;
        margin-top: 0;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 2px solid #f0f0f0;
        font-size: 1.2em;
      }

      .info-row {
        display: flex;
        padding: 10px 0;
        border-bottom: 1px solid #f8f9fa;
      }

      .info-row:last-child {
        border-bottom: none;
      }

      .info-label {
        color: #666;
        min-width: 120px;
        font-weight: 500;
      }

      .info-value {
        color: #333;
        flex: 1;
      }

      /* ç‹€æ…‹æ¨™ç±¤ */
      .status-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 15px;
        font-size: 12px;
        font-weight: 500;
      }

      .status-ARRIVED {
        background-color: #d6eaf8;
        color: #0984e3;
      }

      .status-PENDING {
        background-color: #fff3cd;
        color: #d63031;
      }

      /* åœ–ç‰‡å€åŸŸ */
      .product-images {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin-top: 15px;
      }

      .product-images img {
        width: 100px;
        height: 100px;
        object-fit: cover;
        border-radius: 8px;
        border: 2px solid #e9ecef;
        cursor: pointer;
        transition: transform 0.2s;
      }

      .product-images img:hover {
        transform: scale(1.05);
        border-color: #1a73e8;
      }

      /* è½‰æ›è¡¨å–® */
      .conversion-form {
        background: white;
        border: 2px solid #1a73e8;
        border-radius: 8px;
        padding: 25px;
        margin-bottom: 20px;
      }

      .conversion-form h2 {
        color: #1a73e8;
        margin-top: 0;
        margin-bottom: 25px;
        text-align: center;
      }

      .form-section {
        margin-bottom: 30px;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 8px;
      }

      .form-section h4 {
        color: #333;
        margin-top: 0;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 2px solid #dee2e6;
      }

      .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
      }

      .form-group {
        display: flex;
        flex-direction: column;
      }

      .form-group label {
        color: #555;
        font-weight: 500;
        margin-bottom: 8px;
        font-size: 14px;
      }

      .form-group label.required::after {
        content: " *";
        color: #e74c3c;
      }

      .form-control {
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 14px;
        transition: border-color 0.3s;
      }

      .form-control:focus {
        outline: none;
        border-color: #1a73e8;
        box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.1);
      }

      .form-control:disabled {
        background-color: #f5f5f5;
        cursor: not-allowed;
      }

      textarea.form-control {
        resize: vertical;
        min-height: 80px;
      }

      /* åŠ å¼·ä¿è­·å€å¡Š */
      .protection-section {
        background: #fff8e1;
        border: 1px solid #ffc107;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
      }

      .protection-checkbox {
        display: flex;
        align-items: center;
        margin-bottom: 15px;
      }

      .protection-checkbox input[type="checkbox"] {
        width: 20px;
        height: 20px;
        margin-right: 10px;
        cursor: pointer;
      }

      .protection-checkbox label {
        cursor: pointer;
        font-weight: 500;
        color: #333;
      }

      /* åƒ¹æ ¼è¨ˆç®—å€ */
      .price-summary {
        background: #e8f5e9;
        border: 2px solid #4caf50;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
      }

      .price-summary h4 {
        color: #2e7d32;
        margin-top: 0;
        margin-bottom: 15px;
      }

      .price-item {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid #c8e6c9;
      }

      .price-item:last-child {
        border-bottom: none;
        padding-top: 15px;
        margin-top: 10px;
        border-top: 2px solid #4caf50;
        font-size: 1.2em;
        font-weight: bold;
        color: #1b5e20;
      }

      .price-label {
        color: #555;
      }

      .price-value {
        color: #2e7d32;
        font-weight: 500;
      }

      /* æŒ‰éˆ•å€ */
      .action-buttons {
        display: flex;
        gap: 15px;
        justify-content: center;
        margin-top: 30px;
      }

      .btn {
        padding: 12px 30px;
        font-size: 16px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        transition: all 0.3s;
        font-weight: 500;
      }

      .btn-primary {
        background-color: #1a73e8;
        color: white;
      }

      .btn-primary:hover {
        background-color: #1558b8;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      }

      .btn-primary:disabled {
        background-color: #95a5a6;
        cursor: not-allowed;
        transform: none;
      }

      .btn-success {
        background-color: #27ae60;
        color: white;
      }

      .btn-success:hover {
        background-color: #229954;
      }

      .btn-secondary {
        background-color: #7f8c8d;
        color: white;
      }

      .btn-secondary:hover {
        background-color: #596164;
      }

      /* åˆ†äº«å€å¡Š */
      .share-section {
        background: #e3f2fd;
        border: 2px solid #2196f3;
        border-radius: 8px;
        padding: 20px;
        margin-top: 20px;
        display: none;
      }

      .share-section.active {
        display: block;
      }

      .share-section h4 {
        color: #1565c0;
        margin-top: 0;
        margin-bottom: 15px;
      }

      .share-link-container {
        display: flex;
        gap: 10px;
        margin-top: 15px;
      }

      .share-link-input {
        flex: 1;
        padding: 10px;
        border: 1px solid #90caf9;
        border-radius: 5px;
        font-size: 14px;
        background-color: white;
      }

      .btn-copy {
        padding: 10px 20px;
        background-color: #2196f3;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        transition: background-color 0.3s;
      }

      .btn-copy:hover {
        background-color: #1976d2;
      }

      /* è¼‰å…¥å‹•ç•« */
      .loading-spinner {
        display: none;
        text-align: center;
        padding: 40px;
      }

      .loading-spinner.active {
        display: block;
      }

      .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #1a73e8;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      /* è¨Šæ¯æç¤º */
      .alert {
        padding: 15px 20px;
        border-radius: 5px;
        margin-bottom: 20px;
        display: none;
      }

      .alert.active {
        display: block;
      }

      .alert-success {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }

      .alert-error {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }

      .alert-warning {
        background-color: #fff3cd;
        color: #856404;
        border: 1px solid #ffeeba;
      }

      /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
      @media (max-width: 768px) {
        .main-content {
          grid-template-columns: 1fr;
        }

        .form-grid {
          grid-template-columns: 1fr;
        }

        .page-header {
          flex-direction: column;
          gap: 15px;
          text-align: center;
        }

        .header-actions {
          width: 100%;
        }

        .header-actions button {
          flex: 1;
        }

        .action-buttons {
          flex-direction: column;
        }

        .btn {
          width: 100%;
        }
      }

      /* Logo */
      .header-logo {
        width: 60px;
        height: auto;
        margin-bottom: 20px;
      }
    </style>
  </head>
  <body>
    <div class="calculator-container" style="max-width: 1400px">
      <img src="/assets/logo.png" alt="å°è·‘è±¬ LOGO" class="header-logo" />

      <div class="page-header">
        <h1 class="page-title">åŒ…è£¹è½‰è¨‚å–®</h1>
        <div class="header-actions">
          <button class="btn-back" onclick="goBack()">è¿”å›åŒ…è£¹ç®¡ç†</button>
        </div>
      </div>

      <!-- è­¦å‘Šè¨Šæ¯å€ -->
      <div id="alert-container"></div>

      <!-- è¼‰å…¥ä¸­ -->
      <div id="loading" class="loading-spinner active">
        <div class="spinner"></div>
        <p style="margin-top: 20px; color: #666">è¼‰å…¥åŒ…è£¹è³‡æ–™ä¸­...</p>
      </div>

      <!-- ä¸»è¦å…§å®¹ -->
      <div id="main-content" style="display: none">
        <!-- åŒ…è£¹è³‡è¨Šå€ -->
        <div class="main-content">
          <div class="info-card">
            <h3>åŒ…è£¹è³‡è¨Š</h3>
            <div class="info-row">
              <span class="info-label">ç‰©æµå–®è™Ÿï¼š</span>
              <span class="info-value" id="tracking-number">-</span>
            </div>
            <div class="info-row">
              <span class="info-label">ç‰©æµå…¬å¸ï¼š</span>
              <span class="info-value" id="logistics-company">-</span>
            </div>
            <div class="info-row">
              <span class="info-label">å•†å“åç¨±ï¼š</span>
              <span class="info-value" id="product-name">-</span>
            </div>
            <div class="info-row">
              <span class="info-label">æ•¸é‡ï¼š</span>
              <span class="info-value" id="quantity">-</span>
            </div>
            <div class="info-row">
              <span class="info-label">ç‹€æ…‹ï¼š</span>
              <span class="info-value">
                <span class="status-badge" id="status">-</span>
              </span>
            </div>
            <div class="info-row">
              <span class="info-label">å®¢æˆ¶å‚™è¨»ï¼š</span>
              <span class="info-value" id="customer-note">-</span>
            </div>
            <div id="product-images-container" style="display: none">
              <div class="info-row">
                <span class="info-label">å•†å“åœ–ç‰‡ï¼š</span>
              </div>
              <div class="product-images" id="product-images"></div>
            </div>
          </div>

          <div class="info-card">
            <h3>å®¢æˆ¶è³‡è¨Š</h3>
            <div class="info-row">
              <span class="info-label">å§“åï¼š</span>
              <span class="info-value" id="customer-name">-</span>
            </div>
            <div class="info-row">
              <span class="info-label">é›»å­éƒµä»¶ï¼š</span>
              <span class="info-value" id="customer-email">-</span>
            </div>
            <div class="info-row">
              <span class="info-label">é›»è©±ï¼š</span>
              <span class="info-value" id="customer-phone">-</span>
            </div>
            <div class="info-row">
              <span class="info-label">åœ°å€ï¼š</span>
              <span class="info-value" id="customer-address">-</span>
            </div>
            <div class="info-row">
              <span class="info-label">èº«åˆ†è­‰å­—è™Ÿï¼š</span>
              <span class="info-value" id="customer-id">-</span>
            </div>
            <div class="info-row">
              <span class="info-label">çµ±ä¸€ç·¨è™Ÿï¼š</span>
              <span class="info-value" id="customer-taxid">-</span>
            </div>
          </div>
        </div>

        <!-- è½‰æ›è¡¨å–® -->
        <div class="conversion-form">
          <h2>è½‰æ›ç‚ºæ­£å¼è¨‚å–®</h2>

          <!-- å¯¦éš›æ¸¬é‡å€ -->
          <div class="form-section">
            <h4>ğŸ“ å¯¦éš›æ¸¬é‡æ•¸æ“š</h4>
            <div class="form-grid">
              <div class="form-group">
                <label for="actual-weight" class="required"
                  >å¯¦éš›é‡é‡ (å…¬æ–¤)</label
                >
                <input
                  type="number"
                  id="actual-weight"
                  class="form-control"
                  step="0.1"
                  min="0"
                  placeholder="0.0"
                />
              </div>
              <div class="form-group">
                <label for="actual-length" class="required">é•·åº¦ (å…¬åˆ†)</label>
                <input
                  type="number"
                  id="actual-length"
                  class="form-control"
                  step="0.1"
                  min="0"
                  placeholder="0.0"
                />
              </div>
              <div class="form-group">
                <label for="actual-width" class="required">å¯¬åº¦ (å…¬åˆ†)</label>
                <input
                  type="number"
                  id="actual-width"
                  class="form-control"
                  step="0.1"
                  min="0"
                  placeholder="0.0"
                />
              </div>
              <div class="form-group">
                <label for="actual-height" class="required">é«˜åº¦ (å…¬åˆ†)</label>
                <input
                  type="number"
                  id="actual-height"
                  class="form-control"
                  step="0.1"
                  min="0"
                  placeholder="0.0"
                />
              </div>
              <div class="form-group">
                <label for="actual-cbm">æç© (CBM)</label>
                <input
                  type="text"
                  id="actual-cbm"
                  class="form-control"
                  readonly
                  disabled
                />
              </div>
            </div>
          </div>

          <!-- åŠ å¼·ä¿è­·å€ -->
          <div class="protection-section">
            <h4>ğŸ›¡ï¸ åŠ å¼·ä¿è­·æœå‹™</h4>
            <div class="protection-checkbox">
              <input type="checkbox" id="protection-needed" />
              <label for="protection-needed">éœ€è¦åŠ å¼·ä¿è­·åŒ…è£</label>
            </div>
            <div id="protection-details" style="display: none">
              <div class="form-grid">
                <div class="form-group">
                  <label for="protection-price">åŠ å¼·ä¿è­·è²»ç”¨ (NT$)</label>
                  <input
                    type="number"
                    id="protection-price"
                    class="form-control"
                    step="1"
                    min="0"
                    placeholder="0"
                  />
                </div>
              </div>
              <div class="form-group">
                <label for="protection-note">åŠ å¼·ä¿è­·èªªæ˜</label>
                <textarea
                  id="protection-note"
                  class="form-control"
                  placeholder="èªªæ˜åŠ å¼·ä¿è­·çš„æ–¹å¼..."
                ></textarea>
              </div>
            </div>
          </div>

          <!-- å ±åƒ¹å€ -->
          <div class="form-section">
            <h4>ğŸ’° å ±åƒ¹è³‡è¨Š</h4>
            <div class="form-grid">
              <div class="form-group">
                <label for="shipping-fee" class="required">é‹è²» (NT$)</label>
                <input
                  type="number"
                  id="shipping-fee"
                  class="form-control"
                  step="1"
                  min="0"
                  placeholder="0"
                />
              </div>
              <div class="form-group">
                <label for="service-fee">æœå‹™è²» (NT$)</label>
                <input
                  type="number"
                  id="service-fee"
                  class="form-control"
                  step="1"
                  min="0"
                  value="0"
                />
              </div>
              <div class="form-group">
                <label for="other-fee">å…¶ä»–è²»ç”¨ (NT$)</label>
                <input
                  type="number"
                  id="other-fee"
                  class="form-control"
                  step="1"
                  min="0"
                  value="0"
                />
              </div>
            </div>
            <div class="form-group">
              <label for="quote-note">å ±åƒ¹å‚™è¨»</label>
              <textarea
                id="quote-note"
                class="form-control"
                placeholder="è¼¸å…¥å ±åƒ¹ç›¸é—œèªªæ˜..."
              ></textarea>
            </div>
          </div>

          <!-- åƒ¹æ ¼æ‘˜è¦ -->
          <div class="price-summary">
            <h4>ç¸½è¨ˆ</h4>
            <div class="price-item">
              <span class="price-label">é‹è²»ï¼š</span>
              <span class="price-value"
                >NT$ <span id="summary-shipping">0</span></span
              >
            </div>
            <div class="price-item">
              <span class="price-label">æœå‹™è²»ï¼š</span>
              <span class="price-value"
                >NT$ <span id="summary-service">0</span></span
              >
            </div>
            <div class="price-item">
              <span class="price-label">åŠ å¼·ä¿è­·è²»ï¼š</span>
              <span class="price-value"
                >NT$ <span id="summary-protection">0</span></span
              >
            </div>
            <div class="price-item">
              <span class="price-label">å…¶ä»–è²»ç”¨ï¼š</span>
              <span class="price-value"
                >NT$ <span id="summary-other">0</span></span
              >
            </div>
            <div class="price-item">
              <span class="price-label">ç¸½é‡‘é¡ï¼š</span>
              <span class="price-value"
                >NT$ <span id="summary-total">0</span></span
              >
            </div>
          </div>

          <!-- æŒ‰éˆ•å€ -->
          <div class="action-buttons">
            <button class="btn btn-secondary" onclick="resetForm()">
              é‡ç½®è¡¨å–®
            </button>
            <button
              class="btn btn-primary"
              id="btn-convert"
              onclick="convertToOrder()"
            >
              ç¢ºèªè½‰æ›ç‚ºè¨‚å–®
            </button>
          </div>
        </div>

        <!-- åˆ†äº«å€å¡Š -->
        <div class="share-section" id="share-section">
          <h4>ğŸ“¤ è¨‚å–®åˆ†äº«é€£çµ</h4>
          <p>è¨‚å–®å·²æˆåŠŸå»ºç«‹ï¼è«‹å°‡ä»¥ä¸‹é€£çµåˆ†äº«çµ¦å®¢æˆ¶ï¼š</p>
          <div class="share-link-container">
            <input
              type="text"
              class="share-link-input"
              id="share-link"
              readonly
            />
            <button class="btn-copy" onclick="copyShareLink()">è¤‡è£½é€£çµ</button>
          </div>
          <div class="action-buttons" style="margin-top: 20px">
            <button class="btn btn-success" onclick="viewOrder()">
              æŸ¥çœ‹è¨‚å–®
            </button>
            <button class="btn btn-primary" onclick="createAnother()">
              è½‰æ›å¦ä¸€å€‹åŒ…è£¹
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      // å…¨åŸŸè®Šæ•¸
      let currentParcel = null;
      let currentOrder = null;
      const parcelId = window.location.pathname.split("/").pop();

      // èªè­‰æª¢æŸ¥
      const token = localStorage.getItem("authToken");
      if (!token) {
        window.location.href = "/login.html";
      }

      const headers = {
        Authorization: `Bearer ${token}`,
        "Content-Type": "application/json",
      };

      // åˆå§‹åŒ–
      document.addEventListener("DOMContentLoaded", () => {
        loadParcelData();
        setupEventListeners();
      });

      // è¼‰å…¥åŒ…è£¹è³‡æ–™
      async function loadParcelData() {
        try {
          const response = await fetch(
            `/api/parcel-to-order/check/${parcelId}`,
            {
              headers,
            }
          );

          if (!response.ok) {
            if (response.status === 401) {
              localStorage.removeItem("authToken");
              window.location.href = "/login.html";
              return;
            }
            const error = await response.json();
            showAlert("error", error.error || "è¼‰å…¥å¤±æ•—");
            document.getElementById("loading").classList.remove("active");
            return;
          }

          const data = await response.json();

          if (!data.canConvert) {
            showAlert("warning", data.message);
            document.getElementById("btn-convert").disabled = true;
          }

          currentParcel = data.parcel;
          displayParcelInfo(currentParcel);

          document.getElementById("loading").classList.remove("active");
          document.getElementById("main-content").style.display = "block";
        } catch (error) {
          console.error("è¼‰å…¥åŒ…è£¹è³‡æ–™å¤±æ•—:", error);
          showAlert("error", "ç¶²è·¯éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦");
          document.getElementById("loading").classList.remove("active");
        }
      }

      // é¡¯ç¤ºåŒ…è£¹è³‡è¨Š
      function displayParcelInfo(parcel) {
        // åŒ…è£¹è³‡è¨Š
        document.getElementById("tracking-number").textContent =
          parcel.trackingNumber;
        document.getElementById("logistics-company").textContent =
          parcel.logisticsCompany || "-";
        document.getElementById("product-name").textContent =
          parcel.productName;
        document.getElementById("quantity").textContent = parcel.quantity;
        document.getElementById("customer-note").textContent =
          parcel.note || "ç„¡";

        // ç‹€æ…‹
        const statusBadge = document.getElementById("status");
        statusBadge.textContent = getStatusText(parcel.status);
        statusBadge.className = `status-badge status-${parcel.status}`;

        // å•†å“åœ–ç‰‡
        if (parcel.productImages && parcel.productImages.length > 0) {
          document.getElementById("product-images-container").style.display =
            "block";
          const imagesContainer = document.getElementById("product-images");
          imagesContainer.innerHTML = parcel.productImages
            .map(
              (img) =>
                `<img src="${getFullImageUrl(
                  img
                )}" alt="å•†å“åœ–ç‰‡" onclick="window.open('${getFullImageUrl(
                  img
                )}', '_blank')">`
            )
            .join("");
        }

        // å®¢æˆ¶è³‡è¨Š
        if (parcel.customer) {
          document.getElementById("customer-name").textContent =
            parcel.customer.name;
          document.getElementById("customer-email").textContent =
            parcel.customer.email;
          document.getElementById("customer-phone").textContent =
            parcel.customer.phone || "-";
          document.getElementById("customer-address").textContent =
            parcel.customer.defaultAddress || "å¾…ç¢ºèª";
          document.getElementById("customer-id").textContent =
            parcel.customer.idNumber || "-";
          document.getElementById("customer-taxid").textContent =
            parcel.customer.taxId || "-";
        } else {
          document.getElementById("customer-name").textContent =
            parcel.guestName || "è¨ªå®¢";
          document.getElementById("customer-email").textContent =
            parcel.guestEmail || "-";
          document.getElementById("customer-phone").textContent =
            parcel.guestPhone || "-";
          document.getElementById("customer-address").textContent = "å¾…ç¢ºèª";
          document.getElementById("customer-id").textContent = "-";
          document.getElementById("customer-taxid").textContent = "-";
        }
      }

      // è¨­å®šäº‹ä»¶ç›£è½å™¨
      function setupEventListeners() {
        // å°ºå¯¸è®Šæ›´æ™‚è¨ˆç®—æç©
        ["actual-length", "actual-width", "actual-height"].forEach((id) => {
          document.getElementById(id).addEventListener("input", calculateCBM);
        });

        // åƒ¹æ ¼è®Šæ›´æ™‚æ›´æ–°ç¸½è¨ˆ
        [
          "shipping-fee",
          "service-fee",
          "protection-price",
          "other-fee",
        ].forEach((id) => {
          document
            .getElementById(id)
            .addEventListener("input", updatePriceSummary);
        });

        // åŠ å¼·ä¿è­·å‹¾é¸
        document
          .getElementById("protection-needed")
          .addEventListener("change", (e) => {
            document.getElementById("protection-details").style.display = e
              .target.checked
              ? "block"
              : "none";
            if (!e.target.checked) {
              document.getElementById("protection-price").value = "0";
            }
            updatePriceSummary();
          });
      }

      // è¨ˆç®—æç©
      function calculateCBM() {
        const length =
          parseFloat(document.getElementById("actual-length").value) || 0;
        const width =
          parseFloat(document.getElementById("actual-width").value) || 0;
        const height =
          parseFloat(document.getElementById("actual-height").value) || 0;

        if (length > 0 && width > 0 && height > 0) {
          const cbm = (length * width * height) / 1000000;
          document.getElementById("actual-cbm").value = cbm.toFixed(4) + " mÂ³";
        } else {
          document.getElementById("actual-cbm").value = "";
        }
      }

      // æ›´æ–°åƒ¹æ ¼æ‘˜è¦
      function updatePriceSummary() {
        const shipping =
          parseFloat(document.getElementById("shipping-fee").value) || 0;
        const service =
          parseFloat(document.getElementById("service-fee").value) || 0;
        const protection =
          parseFloat(document.getElementById("protection-price").value) || 0;
        const other =
          parseFloat(document.getElementById("other-fee").value) || 0;
        const total = shipping + service + protection + other;

        document.getElementById("summary-shipping").textContent =
          shipping.toLocaleString();
        document.getElementById("summary-service").textContent =
          service.toLocaleString();
        document.getElementById("summary-protection").textContent =
          protection.toLocaleString();
        document.getElementById("summary-other").textContent =
          other.toLocaleString();
        document.getElementById("summary-total").textContent =
          total.toLocaleString();
      }

      // è½‰æ›ç‚ºè¨‚å–®
      async function convertToOrder() {
        // é©—è­‰å¿…å¡«æ¬„ä½
        const weight = parseFloat(
          document.getElementById("actual-weight").value
        );
        const length = parseFloat(
          document.getElementById("actual-length").value
        );
        const width = parseFloat(document.getElementById("actual-width").value);
        const height = parseFloat(
          document.getElementById("actual-height").value
        );
        const shippingFee = parseFloat(
          document.getElementById("shipping-fee").value
        );

        if (!weight || !length || !width || !height || !shippingFee) {
          showAlert("error", "è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½");
          return;
        }

        if (!confirm("ç¢ºå®šè¦å°‡æ­¤åŒ…è£¹è½‰æ›ç‚ºæ­£å¼è¨‚å–®å—ï¼Ÿ")) {
          return;
        }

        // æº–å‚™è³‡æ–™
        const data = {
          actualWeight: weight,
          actualLength: length,
          actualWidth: width,
          actualHeight: height,
          protectionNeeded:
            document.getElementById("protection-needed").checked,
          protectionPrice:
            parseFloat(document.getElementById("protection-price").value) || 0,
          protectionNote: document.getElementById("protection-note").value,
          finalQuoteData: {
            shipping: shippingFee,
            service:
              parseFloat(document.getElementById("service-fee").value) || 0,
            protection:
              parseFloat(document.getElementById("protection-price").value) ||
              0,
            other: parseFloat(document.getElementById("other-fee").value) || 0,
          },
          finalTotalAmount: parseFloat(
            document
              .getElementById("summary-total")
              .textContent.replace(/,/g, "")
          ),
          quoteNote: document.getElementById("quote-note").value,
        };

        // é¡¯ç¤ºè¼‰å…¥
        document.getElementById("btn-convert").disabled = true;
        document.getElementById("btn-convert").textContent = "è½‰æ›ä¸­...";

        try {
          const response = await fetch(
            `/api/parcel-to-order/convert/${parcelId}`,
            {
              method: "POST",
              headers,
              body: JSON.stringify(data),
            }
          );

          if (!response.ok) {
            const error = await response.json();
            showAlert("error", error.error || "è½‰æ›å¤±æ•—");
            return;
          }

          const result = await response.json();
          currentOrder = result.order;

          showAlert("success", "åŒ…è£¹å·²æˆåŠŸè½‰æ›ç‚ºè¨‚å–®ï¼");

          // é¡¯ç¤ºåˆ†äº«å€å¡Š
          document.getElementById("share-link").value = result.order.shareUrl;
          document.getElementById("share-section").classList.add("active");
          document.querySelector(".conversion-form").style.display = "none";
        } catch (error) {
          console.error("è½‰æ›å¤±æ•—:", error);
          showAlert("error", "ç¶²è·¯éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦");
        } finally {
          document.getElementById("btn-convert").disabled = false;
          document.getElementById("btn-convert").textContent = "ç¢ºèªè½‰æ›ç‚ºè¨‚å–®";
        }
      }

      // è¼”åŠ©å‡½æ•¸
      function getStatusText(status) {
        const statusMap = {
          PENDING: "å¾…ç¢ºèª",
          CONFIRMED: "å·²ç¢ºèª",
          ARRIVED: "å·²åˆ°å€‰",
          COMPLETED: "å·²å®Œæˆ",
          CANCELLED: "å·²å–æ¶ˆ",
        };
        return statusMap[status] || status;
      }

      function getFullImageUrl(imagePath) {
        if (
          imagePath.startsWith("http://") ||
          imagePath.startsWith("https://")
        ) {
          return imagePath;
        }
        const baseUrl = window.location.origin;
        const path = imagePath.startsWith("/") ? imagePath : "/" + imagePath;
        return baseUrl + path;
      }

      function showAlert(type, message) {
        const alertContainer = document.getElementById("alert-container");
        const alert = document.createElement("div");
        alert.className = `alert alert-${type} active`;
        alert.textContent = message;
        alertContainer.innerHTML = "";
        alertContainer.appendChild(alert);

        setTimeout(() => {
          alert.classList.remove("active");
          setTimeout(() => alert.remove(), 300);
        }, 5000);
      }

      function copyShareLink() {
        const input = document.getElementById("share-link");
        input.select();
        document.execCommand("copy");
        showAlert("success", "é€£çµå·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼");
      }

      function resetForm() {
        if (confirm("ç¢ºå®šè¦é‡ç½®è¡¨å–®å—ï¼Ÿæ‰€æœ‰è¼¸å…¥çš„è³‡æ–™å°‡æœƒæ¸…é™¤ã€‚")) {
          document.querySelectorAll(".form-control").forEach((input) => {
            if (!input.disabled && !input.readOnly) {
              input.value = "";
            }
          });
          document.getElementById("protection-needed").checked = false;
          document.getElementById("protection-details").style.display = "none";
          updatePriceSummary();
        }
      }

      function goBack() {
        window.location.href = "/admin-parcels";
      }

      function viewOrder() {
        if (currentOrder) {
          window.open(`/admin?orderId=${currentOrder.id}`, "_blank");
        }
      }

      function createAnother() {
        window.location.href = "/admin-parcels";
      }
    </script>
    <script src="/admin-parcel-convert.js"></script>
  </body>
</html>
