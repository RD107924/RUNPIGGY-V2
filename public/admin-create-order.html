<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>æ‰‹å‹•å»ºç«‹è¨‚å–® - å°è·‘è±¬å¾Œå°ç®¡ç†</title>
    <link rel="icon" type="image/png" href="/assets/logo.png" />
    <link rel="stylesheet" href="style.css" />
    <style>
      /* å°ˆç”¨æ¨£å¼ */
      .create-order-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
      }

      .header-section {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 2px solid #e0e0e0;
      }

      .form-section {
        background: white;
        padding: 25px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        margin-bottom: 25px;
      }

      .form-section h3 {
        color: #1a73e8;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 2px solid #e3f2fd;
      }

      .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
      }

      .form-group {
        margin-bottom: 20px;
      }

      .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: bold;
        color: #333;
      }

      .form-group label .required {
        color: #dc3545;
      }

      .form-control {
        width: 100%;
        padding: 10px;
        border: 2px solid #ddd;
        border-radius: 5px;
        font-size: 14px;
        transition: border-color 0.3s;
      }

      .form-control:focus {
        outline: none;
        border-color: #1a73e8;
        box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.1);
      }

      /* å•†å“é …ç›®æ¨£å¼ */
      .item-container {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 15px;
        border: 2px solid #dee2e6;
        position: relative;
      }

      .item-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
      }

      .item-title {
        font-weight: bold;
        color: #495057;
        font-size: 16px;
      }

      .btn-remove-item {
        background: #dc3545;
        color: white;
        border: none;
        padding: 5px 15px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
      }

      .btn-remove-item:hover {
        background: #c82333;
      }

      /* è¨ˆç®—æ–¹å¼åˆ‡æ› */
      .calc-method-toggle {
        display: flex;
        gap: 15px;
        margin-bottom: 15px;
      }

      .calc-method-toggle label {
        display: flex;
        align-items: center;
        cursor: pointer;
      }

      .calc-method-toggle input[type="radio"] {
        margin-right: 5px;
      }

      /* è¨ˆç®—çµæœé¡¯ç¤º */
      .calculation-summary {
        background: #e3f2fd;
        padding: 20px;
        border-radius: 8px;
        margin-top: 20px;
      }

      .calculation-summary h4 {
        color: #1565c0;
        margin-bottom: 15px;
      }

      .summary-row {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid #bbdefb;
      }

      .summary-row:last-child {
        border-bottom: none;
        font-weight: bold;
        font-size: 18px;
        color: #1565c0;
        padding-top: 15px;
        margin-top: 10px;
        border-top: 2px solid #1976d2;
      }

      /* æŒ‰éˆ•æ¨£å¼ */
      .action-buttons {
        display: flex;
        gap: 15px;
        justify-content: center;
        margin-top: 30px;
      }

      .btn-primary {
        background: #1a73e8;
        color: white;
        padding: 12px 30px;
        border: none;
        border-radius: 5px;
        font-size: 16px;
        cursor: pointer;
        transition: background 0.3s;
      }

      .btn-primary:hover {
        background: #1557b0;
      }

      .btn-secondary {
        background: #6c757d;
        color: white;
        padding: 12px 30px;
        border: none;
        border-radius: 5px;
        font-size: 16px;
        cursor: pointer;
        transition: background 0.3s;
      }

      .btn-secondary:hover {
        background: #5a6268;
      }

      .btn-success {
        background: #28a745;
        color: white;
        padding: 12px 30px;
        border: none;
        border-radius: 5px;
        font-size: 16px;
        cursor: pointer;
        transition: background 0.3s;
      }

      .btn-success:hover {
        background: #218838;
      }

      /* åˆ†äº«å€å¡Š */
      .share-section {
        display: none;
        background: #d4edda;
        padding: 20px;
        border-radius: 8px;
        margin-top: 20px;
        border: 2px solid #c3e6cb;
      }

      .share-section.active {
        display: block;
      }

      .share-url {
        display: flex;
        gap: 10px;
        margin-top: 15px;
      }

      .share-url input {
        flex: 1;
        padding: 10px;
        border: 1px solid #c3e6cb;
        border-radius: 5px;
        background: white;
      }

      .btn-copy {
        background: #28a745;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
      }

      .btn-copy:hover {
        background: #218838;
      }

      /* æç¤ºè¨Šæ¯ */
      .alert {
        padding: 15px;
        border-radius: 5px;
        margin-bottom: 20px;
        display: none;
      }

      .alert.active {
        display: block;
      }

      .alert-success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }

      .alert-error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }

      /* æœå‹™é …ç›®é¸æ“‡ */
      .service-checkbox {
        display: flex;
        align-items: center;
        padding: 10px;
        background: #f8f9fa;
        border-radius: 5px;
        margin-bottom: 10px;
        cursor: pointer;
      }

      .service-checkbox:hover {
        background: #e9ecef;
      }

      .service-checkbox input[type="checkbox"] {
        margin-right: 10px;
      }

      .service-checkbox label {
        cursor: pointer;
        margin: 0;
      }

      /* è¼‰å…¥ä¸­å‹•ç•« */
      .loading {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 9999;
        justify-content: center;
        align-items: center;
      }

      .loading.active {
        display: flex;
      }

      .spinner {
        width: 50px;
        height: 50px;
        border: 5px solid #f3f3f3;
        border-top: 5px solid #1a73e8;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      /* åé åœ°å€é¸æ“‡ */
      .remote-area-selector {
        margin-top: 10px;
      }

      .remote-tag {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        margin-left: 10px;
      }

      .remote-high {
        background: #dc3545;
        color: white;
      }

      .remote-medium {
        background: #ffc107;
        color: #000;
      }

      .remote-low {
        background: #28a745;
        color: white;
      }
    </style>
  </head>
  <body>
    <div class="loading" id="loading">
      <div class="spinner"></div>
    </div>

    <div class="create-order-container">
      <!-- é é¦– -->
      <div class="header-section">
        <div style="display: flex; align-items: center; gap: 20px">
          <img
            src="/assets/logo.png"
            alt="å°è·‘è±¬ LOGO"
            class="header-logo"
            style="height: 50px"
          />
          <h1>æ‰‹å‹•å»ºç«‹è¨‚å–®</h1>
        </div>
        <div>
          <button class="btn-secondary" onclick="window.location.href='/admin'">
            â† è¿”å›ç®¡ç†é é¢
          </button>
        </div>
      </div>

      <!-- æç¤ºè¨Šæ¯ -->
      <div id="alert" class="alert"></div>

      <!-- å®¢æˆ¶è³‡è¨Š -->
      <div class="form-section">
        <h3>ğŸ“‹ å®¢æˆ¶è³‡è¨Š</h3>
        <div class="form-grid">
          <div class="form-group">
            <label>æ”¶ä»¶äººå§“å <span class="required">*</span></label>
            <input
              type="text"
              class="form-control"
              id="recipientName"
              required
            />
          </div>
          <div class="form-group">
            <label>è¯çµ¡é›»è©± <span class="required">*</span></label>
            <input type="tel" class="form-control" id="phone" required />
          </div>
          <div class="form-group">
            <label>é›»å­éƒµä»¶</label>
            <input type="email" class="form-control" id="email" />
          </div>
          <div class="form-group">
            <label>LINE æš±ç¨±</label>
            <input type="text" class="form-control" id="lineNickname" />
          </div>
        </div>
        <div class="form-group">
          <label>æ”¶ä»¶åœ°å€ <span class="required">*</span></label>
          <input type="text" class="form-control" id="address" required />
        </div>
        <div class="form-grid">
          <div class="form-group">
            <label>èº«åˆ†è­‰å­—è™Ÿï¼ˆæ¸…é—œç”¨ï¼‰</label>
            <input
              type="text"
              class="form-control"
              id="idNumber"
              placeholder="é¸å¡«"
            />
          </div>
          <div class="form-group">
            <label>çµ±ä¸€ç·¨è™Ÿï¼ˆå…¬å¸æˆ¶ï¼‰</label>
            <input
              type="text"
              class="form-control"
              id="taxId"
              placeholder="é¸å¡«"
            />
          </div>
        </div>
      </div>

      <!-- é‹é€åœ°å€è¨­å®š -->
      <div class="form-section">
        <h3>ğŸšš é‹é€è¨­å®š</h3>
        <div class="form-group">
          <label>é‹é€åœ°å€ <span class="required">*</span></label>
          <select
            class="form-control"
            id="deliveryLocation"
            onchange="updateRemoteAreaRate()"
          >
            <option value="">è«‹é¸æ“‡é‹é€åœ°å€</option>
            <optgroup label="ä¸€èˆ¬åœ°å€">
              <option value="0">å°åŒ—å¸‚</option>
              <option value="0">æ–°åŒ—å¸‚</option>
              <option value="0">æ¡ƒåœ’å¸‚</option>
              <option value="0">å°ä¸­å¸‚</option>
              <option value="0">å°å—å¸‚</option>
              <option value="0">é«˜é›„å¸‚</option>
            </optgroup>
            <optgroup label="åé åœ°å€ - åŠ æˆ10%">
              <option value="0.1">åŸºéš†å¸‚</option>
              <option value="0.1">æ–°ç«¹å¸‚</option>
              <option value="0.1">æ–°ç«¹ç¸£</option>
              <option value="0.1">è‹—æ —ç¸£</option>
              <option value="0.1">å½°åŒ–ç¸£</option>
              <option value="0.1">å—æŠ•ç¸£</option>
              <option value="0.1">é›²æ—ç¸£</option>
              <option value="0.1">å˜‰ç¾©å¸‚</option>
              <option value="0.1">å˜‰ç¾©ç¸£</option>
              <option value="0.1">å±æ±ç¸£</option>
              <option value="0.1">å®œè˜­ç¸£</option>
            </optgroup>
            <optgroup label="åé åœ°å€ - åŠ æˆ20%">
              <option value="0.2">èŠ±è“®ç¸£</option>
              <option value="0.2">å°æ±ç¸£</option>
            </optgroup>
            <optgroup label="é›¢å³¶åœ°å€ - åŠ æˆ30%">
              <option value="0.3">æ¾æ¹–ç¸£</option>
              <option value="0.3">é‡‘é–€ç¸£</option>
              <option value="0.3">é€£æ±Ÿç¸£ï¼ˆé¦¬ç¥–ï¼‰</option>
              <option value="0.3">ç¶ å³¶</option>
              <option value="0.3">è˜­å¶¼</option>
              <option value="0.3">å°ç‰çƒ</option>
            </optgroup>
          </select>
          <div id="remoteAreaInfo" style="margin-top: 10px; display: none">
            <span id="remoteAreaTag"></span>
            <span
              id="remoteAreaText"
              style="color: #666; margin-left: 10px"
            ></span>
          </div>
        </div>
      </div>

      <!-- å•†å“æ˜ç´° -->
      <div class="form-section">
        <h3>ğŸ“¦ å•†å“æ˜ç´°</h3>
        <div id="itemsContainer">
          <!-- å•†å“é …ç›®å°‡å‹•æ…‹åŠ å…¥é€™è£¡ -->
        </div>
        <button class="btn-primary" onclick="addItem()">+ æ–°å¢å•†å“</button>
      </div>

      <!-- åŠ å€¼æœå‹™ -->
      <div class="form-section">
        <h3>âœ¨ åŠ å€¼æœå‹™</h3>
        <div class="form-grid">
          <div class="service-checkbox">
            <input
              type="checkbox"
              id="service-collect"
              onchange="updateCalculation()"
            />
            <label for="service-collect">ä»£æ”¶è²¨æ¬¾</label>
          </div>
          <div class="service-checkbox">
            <input
              type="checkbox"
              id="service-insurance"
              onchange="updateCalculation()"
            />
            <label for="service-insurance">è²¨ç‰©ä¿éšª</label>
          </div>
          <div class="service-checkbox">
            <input
              type="checkbox"
              id="service-urgent"
              onchange="updateCalculation()"
            />
            <label for="service-urgent">æ€¥ä»¶è™•ç†</label>
          </div>
          <div class="service-checkbox">
            <input
              type="checkbox"
              id="service-install"
              onchange="updateCalculation()"
            />
            <label for="service-install">åˆ°åºœå®‰è£</label>
          </div>
        </div>
        <div class="form-group">
          <label>æœå‹™å‚™è¨»</label>
          <textarea
            class="form-control"
            id="serviceNote"
            rows="3"
            placeholder="è«‹è¼¸å…¥åŠ å€¼æœå‹™çš„ç‰¹æ®Šéœ€æ±‚..."
          ></textarea>
        </div>
      </div>

      <!-- è¨‚å–®è¨­å®š -->
      <div class="form-section">
        <h3>âš™ï¸ è¨‚å–®è¨­å®š</h3>
        <div class="form-grid">
          <div class="form-group">
            <label>è¨‚å–®ç‹€æ…‹ <span class="required">*</span></label>
            <select class="form-control" id="orderStatus">
              <option value="QUOTED">å·²å ±åƒ¹</option>
              <option value="PENDING">å¾…ç¢ºèª</option>
              <option value="CONFIRMED">å·²ç¢ºèª</option>
              <option value="PROCESSING">è™•ç†ä¸­</option>
            </select>
          </div>
          <div class="form-group">
            <label>ä»˜æ¬¾ç‹€æ…‹</label>
            <select class="form-control" id="paymentStatus">
              <option value="UNPAID">æœªä»˜æ¬¾</option>
              <option value="DEPOSIT">å·²ä»˜è¨‚é‡‘</option>
              <option value="PAID">å·²ä»˜å…¨é¡</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label>å…§éƒ¨å‚™è¨»ï¼ˆå®¢æˆ¶ä¸å¯è¦‹ï¼‰</label>
          <textarea
            class="form-control"
            id="internalNote"
            rows="3"
            placeholder="åƒ…ä¾›å…§éƒ¨ä½¿ç”¨çš„å‚™è¨»..."
          ></textarea>
        </div>
      </div>

      <!-- è²»ç”¨è¨ˆç®—æ‘˜è¦ -->
      <div class="form-section">
        <h3>ğŸ’° è²»ç”¨è¨ˆç®—</h3>
        <div class="calculation-summary" id="calculationSummary">
          <h4>è²»ç”¨æ˜ç´°</h4>
          <div class="summary-row">
            <span>åŸºæœ¬é‹è²»ï¼š</span>
            <span id="baseFreight">NT$ 0</span>
          </div>
          <div class="summary-row">
            <span>åé åœ°å€åŠ æˆï¼š</span>
            <span id="remoteFee">NT$ 0</span>
          </div>
          <div class="summary-row">
            <span>è¶…é‡é™„åŠ è²»ï¼š</span>
            <span id="overweightFee">NT$ 0</span>
          </div>
          <div class="summary-row">
            <span>è¶…é•·é™„åŠ è²»ï¼š</span>
            <span id="oversizedFee">NT$ 0</span>
          </div>
          <div class="summary-row">
            <span>åŠ å€¼æœå‹™è²»ï¼š</span>
            <span id="serviceFee">NT$ 0</span>
          </div>
          <div class="summary-row">
            <span>è¨‚å–®ç¸½é‡‘é¡ï¼š</span>
            <span id="totalAmount">NT$ 0</span>
          </div>
        </div>
      </div>

      <!-- æ“ä½œæŒ‰éˆ• -->
      <div class="action-buttons">
        <button class="btn-secondary" onclick="resetForm()">æ¸…é™¤è¡¨å–®</button>
        <button class="btn-primary" onclick="previewOrder()">é è¦½è¨‚å–®</button>
        <button class="btn-success" onclick="createOrder()">
          å»ºç«‹è¨‚å–®ä¸¦åˆ†äº«
        </button>
      </div>

      <!-- åˆ†äº«å€å¡Š -->
      <div class="share-section" id="shareSection">
        <h4>âœ… è¨‚å–®å»ºç«‹æˆåŠŸï¼</h4>
        <p>è¨‚å–®å·²æˆåŠŸå»ºç«‹ï¼Œæ‚¨å¯ä»¥å°‡ä»¥ä¸‹é€£çµåˆ†äº«çµ¦å®¢æˆ¶æŸ¥çœ‹è¨‚å–®è©³æƒ…ï¼š</p>
        <div class="share-url">
          <input type="text" id="shareUrl" readonly />
          <button class="btn-copy" onclick="copyShareUrl()">è¤‡è£½é€£çµ</button>
        </div>
        <div style="margin-top: 15px">
          <button class="btn-primary" onclick="viewOrder()">æŸ¥çœ‹è¨‚å–®</button>
          <button class="btn-secondary" onclick="createNewOrder()">
            å»ºç«‹æ–°è¨‚å–®
          </button>
        </div>
      </div>
    </div>

    <script>
      // å…¨åŸŸè®Šæ•¸
      let itemCount = 0;
      let currentOrder = null;
      const VOLUME_DIVISOR = 28316.85;
      const CBM_TO_CAI_FACTOR = 35.315;

      // é‹è¼¸é¡å‹è³‡æ–™
      const rateOptions = [
        { id: 1, name: "å–®ç´”å ±é—œï¼ˆå¹³å°è³¼è²·å¦‚æ·˜å¯¶ã€æŠ–éŸ³ã€å°ç´…æ›¸ï¼‰", rate: 360 },
        { id: 2, name: "æ™®è²¨ï¼ˆç„¡ç‰Œå­ã€ç™½ç‰Œã€è¼ƒå¤§é‡ç”¢å“ï¼‰", rate: 380 },
        { id: 3, name: "å®¶ç”¨äºŒæ‰‹ç‰©å“", rate: 480 },
        { id: 4, name: "é«˜å–®åƒ¹å•†å“ï¼ˆæœ‰å“ç‰Œæˆ–åŸå» è³¼è²·ï¼‰", rate: 580 },
        { id: 5, name: "é«˜å–®åƒ¹ç”¢å“(å¥¢ä¾ˆå“)ã€é«˜é¢¨éšªå•†å“", rate: 680 },
      ];

      // åˆå§‹åŒ–
      document.addEventListener("DOMContentLoaded", function () {
        // æª¢æŸ¥ç™»å…¥ç‹€æ…‹
        const token = localStorage.getItem("operatorToken");
        if (!token) {
          alert("è«‹å…ˆç™»å…¥");
          window.location.href = "/login.html";
          return;
        }

        // æ–°å¢ç¬¬ä¸€å€‹å•†å“é …ç›®
        addItem();
      });

      // æ–°å¢å•†å“é …ç›®
      function addItem() {
        itemCount++;
        const container = document.getElementById("itemsContainer");

        const itemHtml = `
                <div class="item-container" id="item-${itemCount}">
                    <div class="item-header">
                        <span class="item-title">å•†å“ #${itemCount}</span>
                        ${
                          itemCount > 1
                            ? `<button class="btn-remove-item" onclick="removeItem(${itemCount})">ç§»é™¤</button>`
                            : ""
                        }
                    </div>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label>å•†å“åç¨± <span class="required">*</span></label>
                            <input type="text" class="form-control item-name" required>
                        </div>
                        <div class="form-group">
                            <label>æ•¸é‡ <span class="required">*</span></label>
                            <input type="number" class="form-control item-quantity" min="1" value="1" onchange="updateCalculation()">
                        </div>
                        <div class="form-group">
                            <label>é‹è¼¸é¡å‹ <span class="required">*</span></label>
                            <select class="form-control item-rate" onchange="updateCalculation()">
                                <option value="">è«‹é¸æ“‡é‹è¼¸é¡å‹</option>
                                ${rateOptions
                                  .map(
                                    (rate) =>
                                      `<option value="${rate.id}">ã€${rate.rate}/æã€‘${rate.name}</option>`
                                  )
                                  .join("")}
                            </select>
                        </div>
                    </div>
                    
                    <div class="calc-method-toggle">
                        <label>
                            <input type="radio" name="calc-method-${itemCount}" value="dimensions" checked onchange="toggleCalcMethod(${itemCount})">
                            è¼¸å…¥å°ºå¯¸
                        </label>
                        <label>
                            <input type="radio" name="calc-method-${itemCount}" value="cbm" onchange="toggleCalcMethod(${itemCount})">
                            è¼¸å…¥ç«‹æ–¹ç±³
                        </label>
                    </div>
                    
                    <div class="form-grid" id="dimensions-${itemCount}">
                        <div class="form-group">
                            <label>é•·åº¦ (å…¬åˆ†)</label>
                            <input type="number" class="form-control item-length" min="0" step="0.1" onchange="updateCalculation()">
                        </div>
                        <div class="form-group">
                            <label>å¯¬åº¦ (å…¬åˆ†)</label>
                            <input type="number" class="form-control item-width" min="0" step="0.1" onchange="updateCalculation()">
                        </div>
                        <div class="form-group">
                            <label>é«˜åº¦ (å…¬åˆ†)</label>
                            <input type="number" class="form-control item-height" min="0" step="0.1" onchange="updateCalculation()">
                        </div>
                    </div>
                    
                    <div class="form-group" id="cbm-${itemCount}" style="display: none;">
                        <label>ç«‹æ–¹ç±³</label>
                        <input type="number" class="form-control item-cbm" min="0" step="0.001" onchange="updateCalculation()">
                    </div>
                    
                    <div class="form-group">
                        <label>é‡é‡ (å…¬æ–¤)</label>
                        <input type="number" class="form-control item-weight" min="0" step="0.1" placeholder="é¸å¡«ï¼Œç”¨æ–¼è¨ˆç®—è¶…é‡è²»" onchange="updateCalculation()">
                    </div>
                </div>
            `;

        container.insertAdjacentHTML("beforeend", itemHtml);
        updateCalculation();
      }

      // ç§»é™¤å•†å“é …ç›®
      function removeItem(itemId) {
        if (confirm("ç¢ºå®šè¦ç§»é™¤æ­¤å•†å“å—ï¼Ÿ")) {
          document.getElementById(`item-${itemId}`).remove();
          updateCalculation();
        }
      }

      // åˆ‡æ›è¨ˆç®—æ–¹å¼
      function toggleCalcMethod(itemId) {
        const dimensions = document.getElementById(`dimensions-${itemId}`);
        const cbm = document.getElementById(`cbm-${itemId}`);
        const method = document.querySelector(
          `input[name="calc-method-${itemId}"]:checked`
        ).value;

        if (method === "dimensions") {
          dimensions.style.display = "grid";
          cbm.style.display = "none";
        } else {
          dimensions.style.display = "none";
          cbm.style.display = "block";
        }

        updateCalculation();
      }

      // æ›´æ–°åé åœ°å€è²»ç‡
      function updateRemoteAreaRate() {
        const select = document.getElementById("deliveryLocation");
        const rate = parseFloat(select.value) || 0;
        const info = document.getElementById("remoteAreaInfo");
        const tag = document.getElementById("remoteAreaTag");
        const text = document.getElementById("remoteAreaText");

        if (rate > 0) {
          info.style.display = "block";

          if (rate === 0.3) {
            tag.className = "remote-tag remote-high";
            tag.textContent = "é›¢å³¶åœ°å€";
            text.textContent = `é‹è²»åŠ æˆ ${(rate * 100).toFixed(0)}%`;
          } else if (rate === 0.2) {
            tag.className = "remote-tag remote-medium";
            tag.textContent = "åé åœ°å€";
            text.textContent = `é‹è²»åŠ æˆ ${(rate * 100).toFixed(0)}%`;
          } else if (rate === 0.1) {
            tag.className = "remote-tag remote-low";
            tag.textContent = "åé åœ°å€";
            text.textContent = `é‹è²»åŠ æˆ ${(rate * 100).toFixed(0)}%`;
          }
        } else {
          info.style.display = "none";
        }

        updateCalculation();
      }

      // æ›´æ–°è²»ç”¨è¨ˆç®—
      function updateCalculation() {
        const items = document.querySelectorAll(".item-container");
        let totalVolume = 0;
        let baseFreight = 0;
        let overweightFee = 0;
        let oversizedFee = 0;
        let allItemsData = [];

        items.forEach((item, index) => {
          const name =
            item.querySelector(".item-name").value || `å•†å“ #${index + 1}`;
          const quantity =
            parseInt(item.querySelector(".item-quantity").value) || 0;
          const rateId = item.querySelector(".item-rate").value;
          const weight =
            parseFloat(item.querySelector(".item-weight").value) || 0;

          if (!rateId || quantity === 0) return;

          const rate = rateOptions.find((r) => r.id == rateId);
          if (!rate) return;

          // è¨ˆç®—æç©
          let volume = 0;
          const calcMethod = item.querySelector(
            `input[name^="calc-method"]:checked`
          ).value;

          if (calcMethod === "dimensions") {
            const length =
              parseFloat(item.querySelector(".item-length").value) || 0;
            const width =
              parseFloat(item.querySelector(".item-width").value) || 0;
            const height =
              parseFloat(item.querySelector(".item-height").value) || 0;

            if (length && width && height) {
              volume = ((length * width * height) / VOLUME_DIVISOR) * quantity;

              // æª¢æŸ¥è¶…é•·
              const maxDimension = Math.max(length, width, height);
              if (maxDimension > 200) {
                oversizedFee += 1000 * quantity;
              }
            }
          } else {
            const cbm = parseFloat(item.querySelector(".item-cbm").value) || 0;
            if (cbm) {
              volume = cbm * CBM_TO_CAI_FACTOR * quantity;
            }
          }

          // æª¢æŸ¥è¶…é‡
          if (weight > 50) {
            overweightFee += 500 * quantity;
          }

          totalVolume += volume;
          baseFreight += volume * rate.rate;

          allItemsData.push({
            name,
            quantity,
            volume,
            weight,
            rate: rate.rate,
            rateName: rate.name,
          });
        });

        // åé åœ°å€åŠ æˆ
        const remoteRate =
          parseFloat(document.getElementById("deliveryLocation").value) || 0;
        const remoteFee = baseFreight * remoteRate;

        // åŠ å€¼æœå‹™è²»
        let serviceFee = 0;
        if (document.getElementById("service-collect").checked)
          serviceFee += 500;
        if (document.getElementById("service-insurance").checked)
          serviceFee += 300;
        if (document.getElementById("service-urgent").checked)
          serviceFee += 1000;
        if (document.getElementById("service-install").checked)
          serviceFee += 1500;

        // ç¸½è¨ˆ
        const totalAmount =
          baseFreight + remoteFee + overweightFee + oversizedFee + serviceFee;

        // æ›´æ–°é¡¯ç¤º
        document.getElementById(
          "baseFreight"
        ).textContent = `NT$ ${baseFreight.toLocaleString()}`;
        document.getElementById(
          "remoteFee"
        ).textContent = `NT$ ${remoteFee.toLocaleString()}`;
        document.getElementById(
          "overweightFee"
        ).textContent = `NT$ ${overweightFee.toLocaleString()}`;
        document.getElementById(
          "oversizedFee"
        ).textContent = `NT$ ${oversizedFee.toLocaleString()}`;
        document.getElementById(
          "serviceFee"
        ).textContent = `NT$ ${serviceFee.toLocaleString()}`;
        document.getElementById(
          "totalAmount"
        ).textContent = `NT$ ${totalAmount.toLocaleString()}`;

        return {
          allItemsData,
          totalVolume,
          baseFreight,
          remoteFee,
          remoteRate,
          overweightFee,
          oversizedFee,
          serviceFee,
          totalAmount,
        };
      }

      // é è¦½è¨‚å–®
      function previewOrder() {
        // é©—è­‰å¿…å¡«æ¬„ä½
        if (!validateForm()) {
          showAlert("error", "è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½");
          return;
        }

        const calculation = updateCalculation();

        // å»ºç«‹é è¦½å…§å®¹
        const previewContent = `
                <h2>è¨‚å–®é è¦½</h2>
                <h3>å®¢æˆ¶è³‡è¨Š</h3>
                <p>æ”¶ä»¶äººï¼š${document.getElementById("recipientName").value}</p>
                <p>é›»è©±ï¼š${document.getElementById("phone").value}</p>
                <p>åœ°å€ï¼š${document.getElementById("address").value}</p>
                
                <h3>å•†å“æ˜ç´°</h3>
                ${calculation.allItemsData
                  .map(
                    (item) => `
                    <p>${item.name} x ${
                      item.quantity
                    } - æç©ï¼š${item.volume.toFixed(2)}æ</p>
                `
                  )
                  .join("")}
                
                <h3>è²»ç”¨ç¸½è¨ˆ</h3>
                <p>ç¸½é‡‘é¡ï¼šNT$ ${calculation.totalAmount.toLocaleString()}</p>
            `;

        // é¡¯ç¤ºé è¦½ï¼ˆå¯ä»¥ç”¨ modal æˆ–å…¶ä»–æ–¹å¼ï¼‰
        if (
          confirm(
            "ç¢ºèªè¨‚å–®è³‡è¨Šæ­£ç¢ºå—ï¼Ÿ\n\n" + previewContent.replace(/<[^>]*>/g, "")
          )
        ) {
          createOrder();
        }
      }

      // å»ºç«‹è¨‚å–®
      async function createOrder() {
        if (!validateForm()) {
          showAlert("error", "è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½");
          return;
        }

        const loading = document.getElementById("loading");
        loading.classList.add("active");

        try {
          const calculation = updateCalculation();

          // æ”¶é›†åŠ å€¼æœå‹™
          const services = [];
          if (document.getElementById("service-collect").checked)
            services.push("ä»£æ”¶è²¨æ¬¾");
          if (document.getElementById("service-insurance").checked)
            services.push("è²¨ç‰©ä¿éšª");
          if (document.getElementById("service-urgent").checked)
            services.push("æ€¥ä»¶è™•ç†");
          if (document.getElementById("service-install").checked)
            services.push("åˆ°åºœå®‰è£");

          const orderData = {
            // å®¢æˆ¶è³‡è¨Š
            recipientName: document.getElementById("recipientName").value,
            phone: document.getElementById("phone").value,
            email: document.getElementById("email").value || null,
            lineNickname: document.getElementById("lineNickname").value || null,
            address: document.getElementById("address").value,
            idNumber: document.getElementById("idNumber").value || null,
            taxId: document.getElementById("taxId").value || null,

            // è¨ˆç®—çµæœ
            calculationResult: calculation,

            // åŠ å€¼æœå‹™
            additionalServices: services.length > 0 ? services : null,
            serviceNote: document.getElementById("serviceNote").value || null,

            // è¨‚å–®è¨­å®š
            status: document.getElementById("orderStatus").value,
            paymentStatus: document.getElementById("paymentStatus").value,
            internalNote: document.getElementById("internalNote").value || null,

            // æ¨™è¨˜ç‚ºå“¡å·¥å»ºç«‹
            createdBy: "STAFF",
            shareEnabled: true,
          };

          const token = localStorage.getItem("operatorToken");
          const response = await fetch("/api/admin/orders/manual", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify(orderData),
          });

          if (!response.ok) {
            throw new Error("å»ºç«‹è¨‚å–®å¤±æ•—");
          }

          const result = await response.json();
          currentOrder = result;

          // é¡¯ç¤ºåˆ†äº«å€å¡Š
          const shareUrl = `${window.location.origin}/order-share/${result.shareToken}`;
          document.getElementById("shareUrl").value = shareUrl;
          document.getElementById("shareSection").classList.add("active");

          showAlert("success", "è¨‚å–®å»ºç«‹æˆåŠŸï¼");

          // æ²å‹•åˆ°åˆ†äº«å€å¡Š
          document
            .getElementById("shareSection")
            .scrollIntoView({ behavior: "smooth" });
        } catch (error) {
          console.error("å»ºç«‹è¨‚å–®éŒ¯èª¤:", error);
          showAlert("error", "å»ºç«‹è¨‚å–®å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
        } finally {
          loading.classList.remove("active");
        }
      }

      // é©—è­‰è¡¨å–®
      function validateForm() {
        const required = [
          "recipientName",
          "phone",
          "address",
          "deliveryLocation",
        ];

        for (const field of required) {
          const value = document.getElementById(field).value;
          if (!value || value.trim() === "") {
            document.getElementById(field).focus();
            return false;
          }
        }

        // æª¢æŸ¥è‡³å°‘æœ‰ä¸€å€‹å•†å“
        const items = document.querySelectorAll(".item-container");
        let hasValidItem = false;

        items.forEach((item) => {
          const name = item.querySelector(".item-name").value;
          const rate = item.querySelector(".item-rate").value;
          if (name && rate) {
            hasValidItem = true;
          }
        });

        if (!hasValidItem) {
          showAlert("error", "è«‹è‡³å°‘æ–°å¢ä¸€å€‹å•†å“");
          return false;
        }

        return true;
      }

      // è¤‡è£½åˆ†äº«é€£çµ
      function copyShareUrl() {
        const input = document.getElementById("shareUrl");
        input.select();
        document.execCommand("copy");

        const btn = event.target;
        const originalText = btn.textContent;
        btn.textContent = "å·²è¤‡è£½ï¼";
        btn.style.background = "#28a745";

        setTimeout(() => {
          btn.textContent = originalText;
          btn.style.background = "";
        }, 2000);
      }

      // æŸ¥çœ‹è¨‚å–®
      function viewOrder() {
        if (currentOrder) {
          window.open(`/order-share/${currentOrder.shareToken}`, "_blank");
        }
      }

      // å»ºç«‹æ–°è¨‚å–®
      function createNewOrder() {
        if (confirm("ç¢ºå®šè¦å»ºç«‹æ–°è¨‚å–®å—ï¼Ÿç›®å‰çš„è³‡æ–™å°‡æœƒæ¸…é™¤ã€‚")) {
          resetForm();
          document.getElementById("shareSection").classList.remove("active");
        }
      }

      // é‡ç½®è¡¨å–®
      function resetForm() {
        if (!confirm("ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰è³‡æ–™å—ï¼Ÿ")) {
          return;
        }

        document.querySelectorAll(".form-control").forEach((input) => {
          if (input.type === "checkbox") {
            input.checked = false;
          } else if (input.tagName === "SELECT") {
            input.selectedIndex = 0;
          } else {
            input.value = "";
          }
        });

        // é‡ç½®å•†å“é …ç›®
        document.getElementById("itemsContainer").innerHTML = "";
        itemCount = 0;
        addItem();

        // é‡ç½®è¨ˆç®—
        updateCalculation();

        // éš±è—åˆ†äº«å€å¡Š
        document.getElementById("shareSection").classList.remove("active");

        showAlert("success", "è¡¨å–®å·²æ¸…é™¤");
      }

      // é¡¯ç¤ºæç¤ºè¨Šæ¯
      function showAlert(type, message) {
        const alert = document.getElementById("alert");
        alert.className = `alert alert-${type} active`;
        alert.textContent = message;

        setTimeout(() => {
          alert.classList.remove("active");
        }, 5000);
      }
    </script>
  </body>
</html>
