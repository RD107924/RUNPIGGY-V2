<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>包裹預報管理 - 管理後台</title>
    <link rel="stylesheet" href="admin-styles.css" />
    <style>
      .stats-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .stat-card {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        text-align: center;
      }

      .stat-card h3 {
        color: #666;
        font-size: 14px;
        margin-bottom: 10px;
      }

      .stat-card p {
        color: #333;
        font-size: 28px;
        font-weight: bold;
        margin: 0;
      }

      .filters {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
      }

      .filters select,
      .filters input {
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
      }

      .filters input {
        flex: 1;
        max-width: 300px;
      }

      .status-select {
        padding: 5px;
        border-radius: 4px;
        border: 1px solid #ddd;
      }

      .status-badge {
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: bold;
      }

      .status-PENDING {
        background-color: #ffeaa7;
        color: #d63031;
      }

      .status-CONFIRMED {
        background-color: #55efc4;
        color: #00b894;
      }

      .status-ARRIVED {
        background-color: #74b9ff;
        color: #0984e3;
      }

      .status-COMPLETED {
        background-color: #81ecec;
        color: #00cec9;
      }

      .status-CANCELLED {
        background-color: #fab1a0;
        color: #e17055;
      }

      .btn-view {
        padding: 5px 10px;
        background-color: #4a69bd;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }

      .btn-view:hover {
        background-color: #3c5aa6;
      }

      .parcel-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
      }

      .parcel-table th,
      .parcel-table td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #ddd;
      }

      .parcel-table th {
        background-color: #f8f9fa;
        font-weight: bold;
        color: #495057;
      }

      .parcel-images {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin-top: 10px;
      }

      .parcel-images img {
        width: 100px;
        height: 100px;
        object-fit: cover;
        border-radius: 4px;
        cursor: pointer;
      }

      /* 訪客標籤 */
      .guest-badge {
        display: inline-block;
        padding: 2px 6px;
        background-color: #ff7675;
        color: white;
        border-radius: 3px;
        font-size: 11px;
        margin-left: 5px;
      }
    </style>
  </head>
  <body>
    <div class="admin-container">
      <div class="admin-header">
        <h1>包裹預報管理</h1>
        <div class="header-actions">
          <button onclick="window.location.href='/admin'">返回主頁</button>
          <button id="logoutBtn">登出</button>
        </div>
      </div>

      <!-- 統計卡片 -->
      <div class="stats-container">
        <div class="stat-card">
          <h3>總預報數</h3>
          <p id="stats-total">0</p>
        </div>
        <div class="stat-card">
          <h3>待確認</h3>
          <p id="stats-pending">0</p>
        </div>
        <div class="stat-card">
          <h3>已確認</h3>
          <p id="stats-confirmed">0</p>
        </div>
        <div class="stat-card">
          <h3>已到倉</h3>
          <p id="stats-arrived">0</p>
        </div>
        <div class="stat-card">
          <h3>已完成</h3>
          <p id="stats-completed">0</p>
        </div>
      </div>

      <!-- 篩選器 -->
      <div class="filters">
        <select id="filter-status">
          <option value="">所有狀態</option>
          <option value="PENDING">待確認</option>
          <option value="CONFIRMED">已確認</option>
          <option value="ARRIVED">已到倉</option>
          <option value="COMPLETED">已完成</option>
          <option value="CANCELLED">已取消</option>
        </select>
        <select id="filter-type">
          <option value="">所有類型</option>
          <option value="member">會員包裹</option>
          <option value="guest">訪客包裹</option>
        </select>
        <input
          type="text"
          id="search-input"
          placeholder="搜尋單號/商品名稱/物流公司..."
        />
      </div>

      <!-- 包裹列表 -->
      <div class="parcel-management">
        <div class="admin-table-wrapper" style="overflow-x: auto">
          <table class="parcel-table">
            <thead>
              <tr>
                <th>操作</th>
                <th>預報時間</th>
                <th>客戶資訊</th>
                <th>物流單號</th>
                <th>商品名稱</th>
                <th>數量</th>
                <th>狀態</th>
                <th>備註</th>
              </tr>
            </thead>
            <tbody id="parcelsTableBody">
              <tr>
                <td colspan="8" style="text-align: center">載入中...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- 詳情彈窗 -->
    <div id="parcel-detail-modal" class="modal-overlay" style="display: none">
      <div class="modal-content" style="max-width: 800px">
        <button class="modal-close-btn">&times;</button>
        <h2>包裹預報詳情</h2>
        <div id="modal-body"></div>
      </div>
    </div>

    <script>
      const token = localStorage.getItem("authToken");
      if (!token) {
        window.location.href = "/login.html";
      }

      const headers = {
        Authorization: `Bearer ${token}`,
        "Content-Type": "application/json",
      };

      let allParcels = [];

      // DOM Elements
      const parcelsTableBody = document.getElementById("parcelsTableBody");
      const filterStatus = document.getElementById("filter-status");
      const filterType = document.getElementById("filter-type");
      const searchInput = document.getElementById("search-input");
      const modal = document.getElementById("parcel-detail-modal");
      const modalBody = document.getElementById("modal-body");
      const closeModalBtn = document.querySelector(".modal-close-btn");

      // Event Listeners
      document.getElementById("logoutBtn").addEventListener("click", () => {
        localStorage.removeItem("authToken");
        window.location.href = "/login.html";
      });

      closeModalBtn.addEventListener(
        "click",
        () => (modal.style.display = "none")
      );
      modal.addEventListener("click", (e) => {
        if (e.target === modal) modal.style.display = "none";
      });

      filterStatus.addEventListener("change", fetchParcels);
      filterType.addEventListener("change", fetchParcels);
      searchInput.addEventListener("input", fetchParcels);

      // 載入統計資料
      async function loadStats() {
        try {
          const response = await fetch("/api/parcels/admin/stats", { headers });
          if (response.ok) {
            const stats = await response.json();
            document.getElementById("stats-total").textContent =
              stats.totalParcels || 0;
            document.getElementById("stats-pending").textContent =
              stats.pendingParcels || 0;
            document.getElementById("stats-confirmed").textContent =
              stats.confirmedParcels || 0;
            document.getElementById("stats-arrived").textContent =
              stats.arrivedParcels || 0;
            document.getElementById("stats-completed").textContent =
              stats.completedParcels || 0;
          }
        } catch (error) {
          console.error("載入統計失敗:", error);
        }
      }

      // 載入包裹列表
      async function fetchParcels() {
        try {
          const params = new URLSearchParams();

          if (filterStatus.value) {
            params.append("status", filterStatus.value);
          }

          if (filterType.value === "member") {
            params.append("isGuest", "false");
          } else if (filterType.value === "guest") {
            params.append("isGuest", "true");
          }

          if (searchInput.value) {
            params.append("search", searchInput.value);
          }

          const response = await fetch(`/api/parcels/admin?${params}`, {
            headers,
          });

          if (response.ok) {
            allParcels = await response.json();
            renderParcels(allParcels);
          } else if (response.status === 401) {
            localStorage.removeItem("authToken");
            window.location.href = "/login.html";
          } else {
            const error = await response.json();
            console.error("API 錯誤:", error);
            parcelsTableBody.innerHTML = `<tr><td colspan="8" style="text-align: center; color: red;">載入失敗: ${
              error.error || "未知錯誤"
            }</td></tr>`;
          }
        } catch (error) {
          console.error("載入包裹失敗:", error);
          parcelsTableBody.innerHTML =
            '<tr><td colspan="8" style="text-align: center; color: red;">載入失敗: 網路錯誤</td></tr>';
        }
      }

      // 渲染包裹列表
      function renderParcels(parcels) {
        if (parcels.length === 0) {
          parcelsTableBody.innerHTML =
            '<tr><td colspan="8" style="text-align: center;">暫無資料</td></tr>';
          return;
        }

        const statusMap = {
          PENDING: "待確認",
          CONFIRMED: "已確認",
          ARRIVED: "已到倉",
          COMPLETED: "已完成",
          CANCELLED: "已取消",
        };

        parcelsTableBody.innerHTML = parcels
          .map((parcel) => {
            // 判斷是會員還是訪客
            const isGuest = !parcel.customerId;
            let customerInfo = "";

            if (isGuest) {
              // 訪客資訊
              customerInfo = `
                ${
                  parcel.guestName || "訪客"
                }<span class="guest-badge">訪客</span>
                <br><small>${parcel.guestEmail || ""}</small>
                <br><small>${parcel.guestPhone || ""}</small>
              `;
            } else if (parcel.customer) {
              // 會員資訊
              customerInfo = `
                ${parcel.customer.name}
                <br><small>${parcel.customer.email}</small>
              `;
            } else {
              // 備用：如果沒有客戶資訊
              customerInfo = '<span style="color: #999;">無客戶資訊</span>';
            }

            return `
                <tr>
                    <td><button class="btn-view" data-parcel-id="${
                      parcel.id
                    }">查看</button></td>
                    <td>${new Date(parcel.createdAt).toLocaleString()}</td>
                    <td>${customerInfo}</td>
                    <td>${parcel.trackingNumber}<br><small>${
              parcel.logisticsCompany || "-"
            }</small></td>
                    <td>${parcel.productName}</td>
                    <td>${parcel.quantity}</td>
                    <td>
                        <select class="status-select" data-parcel-id="${
                          parcel.id
                        }">
                            <option value="PENDING" ${
                              parcel.status === "PENDING" ? "selected" : ""
                            }>待確認</option>
                            <option value="CONFIRMED" ${
                              parcel.status === "CONFIRMED" ? "selected" : ""
                            }>已確認</option>
                            <option value="ARRIVED" ${
                              parcel.status === "ARRIVED" ? "selected" : ""
                            }>已到倉</option>
                            <option value="COMPLETED" ${
                              parcel.status === "COMPLETED" ? "selected" : ""
                            }>已完成</option>
                            <option value="CANCELLED" ${
                              parcel.status === "CANCELLED" ? "selected" : ""
                            }>已取消</option>
                        </select>
                    </td>
                    <td>${parcel.adminNote || "-"}</td>
                </tr>
            `;
          })
          .join("");

        // 綁定事件
        document.querySelectorAll(".btn-view").forEach((btn) => {
          btn.addEventListener("click", (e) => {
            const parcelId = e.target.dataset.parcelId;
            showParcelDetail(parcelId);
          });
        });

        document.querySelectorAll(".status-select").forEach((select) => {
          select.addEventListener("change", (e) => {
            const parcelId = e.target.dataset.parcelId;
            const newStatus = e.target.value;
            updateParcelStatus(parcelId, newStatus);
          });
        });
      }

      // 顯示包裹詳情
      function showParcelDetail(parcelId) {
        const parcel = allParcels.find((p) => p.id === parcelId);
        if (!parcel) return;

        const statusMap = {
          PENDING: "待確認",
          CONFIRMED: "已確認",
          ARRIVED: "已到倉",
          COMPLETED: "已完成",
          CANCELLED: "已取消",
        };

        // 判斷是會員還是訪客
        const isGuest = !parcel.customerId;
        let customerSection = "";

        if (isGuest) {
          customerSection = `
            <h3>訪客資訊</h3>
            <p><strong>姓名：</strong>${parcel.guestName || "訪客"}</p>
            <p><strong>電子郵件：</strong>${parcel.guestEmail || "-"}</p>
            <p><strong>電話：</strong>${parcel.guestPhone || "-"}</p>
            ${
              parcel.queryCode
                ? `<p><strong>查詢碼：</strong>${parcel.queryCode}</p>`
                : ""
            }
          `;
        } else if (parcel.customer) {
          customerSection = `
            <h3>會員資訊</h3>
            <p><strong>姓名：</strong>${parcel.customer.name}</p>
            <p><strong>電子郵件：</strong>${parcel.customer.email}</p>
            <p><strong>電話：</strong>${parcel.customer.phone || "-"}</p>
          `;
        }

        modalBody.innerHTML = `
            <div class="parcel-detail">
                ${customerSection}
                
                <h3>包裹資訊</h3>
                <p><strong>物流單號：</strong>${parcel.trackingNumber}</p>
                <p><strong>物流公司：</strong>${
                  parcel.logisticsCompany || "-"
                }</p>
                <p><strong>商品名稱：</strong>${parcel.productName}</p>
                <p><strong>商品連結：</strong>${
                  parcel.productLink
                    ? `<a href="${parcel.productLink}" target="_blank">${parcel.productLink}</a>`
                    : "-"
                }</p>
                <p><strong>數量：</strong>${parcel.quantity}</p>
                <p><strong>狀態：</strong><span class="status-badge status-${
                  parcel.status
                }">${statusMap[parcel.status]}</span></p>
                <p><strong>備註：</strong>${parcel.note || "-"}</p>
                <p><strong>管理員備註：</strong>${parcel.adminNote || "-"}</p>
                
                <h3>時間記錄</h3>
                <p><strong>預報時間：</strong>${new Date(
                  parcel.createdAt
                ).toLocaleString()}</p>
                ${
                  parcel.confirmedAt
                    ? `<p><strong>確認時間：</strong>${new Date(
                        parcel.confirmedAt
                      ).toLocaleString()}</p>`
                    : ""
                }
                ${
                  parcel.arrivedAt
                    ? `<p><strong>到倉時間：</strong>${new Date(
                        parcel.arrivedAt
                      ).toLocaleString()}</p>`
                    : ""
                }
                
                ${
                  parcel.productImages && parcel.productImages.length > 0
                    ? `
                    <h3>商品圖片</h3>
                    <div class="parcel-images">
                        ${parcel.productImages
                          .map(
                            (img) =>
                              `<img src="${img}" alt="商品圖片" onclick="window.open('${img}', '_blank')">`
                          )
                          .join("")}
                    </div>
                `
                    : ""
                }
                
                <h3>更新管理員備註</h3>
                <textarea id="admin-note-input" style="width: 100%; height: 60px; margin-bottom: 10px;">${
                  parcel.adminNote || ""
                }</textarea>
                <button onclick="updateAdminNote('${parcelId}')" style="padding: 8px 16px; background-color: #4a69bd; color: white; border: none; border-radius: 4px; cursor: pointer;">更新備註</button>
            </div>
        `;

        modal.style.display = "block";
      }

      // 更新包裹狀態
      async function updateParcelStatus(parcelId, newStatus) {
        try {
          const response = await fetch(
            `/api/parcels/admin/${parcelId}/status`,
            {
              method: "PUT",
              headers,
              body: JSON.stringify({ status: newStatus }),
            }
          );

          if (response.ok) {
            await fetchParcels();
            await loadStats();
            alert("狀態更新成功");
          } else {
            alert("狀態更新失敗");
          }
        } catch (error) {
          console.error("更新狀態失敗:", error);
          alert("網路錯誤");
        }
      }

      // 更新管理員備註
      async function updateAdminNote(parcelId) {
        const adminNote = document.getElementById("admin-note-input").value;

        try {
          const response = await fetch(
            `/api/parcels/admin/${parcelId}/status`,
            {
              method: "PUT",
              headers,
              body: JSON.stringify({
                status: allParcels.find((p) => p.id === parcelId).status,
                adminNote: adminNote,
              }),
            }
          );

          if (response.ok) {
            await fetchParcels();
            modal.style.display = "none";
            alert("備註更新成功");
          } else {
            alert("備註更新失敗");
          }
        } catch (error) {
          console.error("更新備註失敗:", error);
          alert("網路錯誤");
        }
      }

      // 初始化
      loadStats();
      fetchParcels();
    </script>
  </body>
</html>
